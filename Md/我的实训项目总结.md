# 实训项目

## 1 项目结构 

- mingrui-shop-parent

  - ​    mingrui-shop-basics

    - mingrui-shop-config-server

    - mingrui-shop-eureka-server 8761

    - mingrui-shop-zuul-server 8088 --> 80

    - mingrui-shop-upload-server 80001

    - ..........................

      

  - mingrui-shop-commons

    - mingrui-shop-common-core
    - ​    .....................................

  - mingrui-shop-services

    - mingrui-shop-service-categoty 8100

    - mingrui-shop-service-brand 8200

    - mingrui-shop-service-spec 8300

      

  - mingrui-shop-services-api

    - mingrui-shop-service-api-categoty
    - mingrui-shop-service-api-brand
    - mingrui-shop-service-api-spec

## 2 项目搭建 

#### 	2.1 应用到的技术

##### 			2.1.1  前端技术：	

```text
- ​	基础的HTML、CSS、JavaScript（基于ES6标准）
- ​	JQuery
- ​	Vue.js 2.0以及基于Vue的UI框架：Vuetify
- ​	前端构建工具：WebPack
- ​	前端安装包工具：NPM
- ​ Vue脚手架：Vue-cli
- ​	Vue路由：vue-router
- ​	ajax框架：axios
- ​基于Vue的富文本框架：quill-editor
```

#####             2.1.2  后端技术：

```text
- ​	 基础的SpringMVC、Spring 5.0和MyBatis3
- ​  Spring Boot 2.2.2版本
- ​  Spring Cloud 版本 Hoxton.SR1
- ​  Redis-4.0
- ​  RabbitMQ-3.8
- ​  Elasticsearch-5.6.8
- ​  nginx-1.10.2
- ​  FastDFS - 5.0.8
- ​  MyCat
- ​  Thymeleaf
- ​  JWT
```



#### 2.2   开发环境

为了保证开发环境的统一，希望每个人都按照我的环境来配置：

- IDE：我们使用Idea 

- JDK：统一使用JDK1.8

- 项目构建：maven3.3.9以上版本即可

- 版本控制工具：git

#### 2.3  域名  ： 为了保证生产 和测试的环境一致， 尽量都采用域名来访问项目

​	一级域名 ： www.mrshop.com

​	二级域名： manage.mrshop.com , api.mrshop.com



#### **2.4. 创建项目**

##### 2.4.1 创建父级工程

mingrui-shop-parent

​	删除src文件夹

##### 2.4.2 **pom.xml配置文件jar包**

- 在父级项目里添加依赖:

- ```
  <?xml version="1.0" encoding="UTF-8"?>
  <project xmlns="http://maven.apache.org/POM/4.0.0"
           xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
           xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
      <modelVersion>4.0.0</modelVersion>
  
      <groupId>com.baidu</groupId>
      <artifactId>mingrui-shop-parent</artifactId>
      <version>1.0-SNAPSHOT</version>
      <modules>
          <module>mingrui-shop-basics</module>
          <module>mingrui-shop-commons</module>
          <module>mingrui-shop-service</module>
          <module>mingrui-shop-service-api</module>
      </modules>
  
      <packaging>pom</packaging>
  
      <properties>
          <!--项目构建编码-->
          <project.build.sourceEncoding>UTF-8</project.build.sourceEncoding>
          <project.reporting.outputEncoding>UTF-8</project.reporting.outputEncoding>
          <!--声明JDK版本-->
          <java.version>1.8</java.version>
          <!--spring cloud 版本.注意此版本是建立在boot2.2.2版本上的-->
          <mr.spring.cloud.version>Hoxton.SR1</mr.spring.cloud.version>
      </properties>
  
      <!--boot 版本-->
      <parent>
          <groupId>org.springframework.boot</groupId>
          <artifactId>spring-boot-starter-parent</artifactId>
          <version>2.3.1.RELEASE</version>
          <!--始终从仓库中获取，不从本地路径获取-->
          <relativePath />
      </parent>
  
      <dependencies>
          <!-- 集成commons工具类 -->
          <dependency>
              <groupId>org.apache.commons</groupId>
              <artifactId>commons-lang3</artifactId>
          </dependency>
  
          <!-- 集成lombok 框架 -->
          <dependency>
              <groupId>org.projectlombok</groupId>
              <artifactId>lombok</artifactId>
          </dependency>
  
          <!--junit测试
          在公司 实际项目中这个依赖可能没有-->
          <dependency>
              <groupId>junit</groupId>
              <artifactId>junit</artifactId>
          </dependency>
  
          <!-- SpringBoot整合eureka客户端 -->
          <dependency>
              <groupId>org.springframework.cloud</groupId>
              <artifactId>spring-cloud-starter-netflix-eureka-client</artifactId>
          </dependency>
  
          <!--boot 测试模块-->
          <dependency>
              <groupId>org.springframework.boot</groupId>
              <artifactId>spring-boot-starter-test</artifactId>
              <scope>test</scope>
          </dependency>
  
      </dependencies>
  
  
      <!-- 项目依赖,子级模块可以继承依赖-->
      <dependencyManagement>
  
          <dependencies>
  
              <!--cloud 依赖-->
              <dependency>
                  <groupId>org.springframework.cloud</groupId>
                  <artifactId>spring-cloud-dependencies</artifactId>
                  <version>${mr.spring.cloud.version}</version>
                  <type>pom</type>
                  <!--解决maven单继承的问题-->
                  <scope>import</scope>
              </dependency>
  
          </dependencies>
  
      </dependencyManagement>
  
      <!-- 注意： 这里必须要添加， 否者各种依赖有问题 -->
      <repositories>
          <repository>
              <id>spring-milestones</id>
              <name>Spring Milestones</name>
              <url>https://repo.spring.io/libs-milestone</url>
              <snapshots>
                  <enabled>false</enabled>
              </snapshots>
          </repository>
      </repositories>
  
  </project>
  ```

  

##### 2.5 创建基础服务父工程

- 在mingrui-shop-parent 工程名上右键-->new-->module

  - 项目名为: mingrui-shop-basics

  - ```
    在pom.xml里配置:<!--父级项目不需要打包所有packging的类型为pom--><packging>pom</packging>
    ```

    

  **在创建一个公共(工具)工程**

- . 在mingrui-shop-parent 工程名上右键-->new-->module

  -  项目名为: mingrui-shop-commoms

  删除src文件夹 然后在pom.xml里配置

  - ```
    	<!--父级项目不需要打包所有packging的类型为pom-->
      	<packging>pom</packging>
    ```

    

  **在创建一个服务实现工程**

- 在mingrui-shop-parent 工程名上右键-->new-->module

- 项目名为: mingrui-shop-service

- 删除src文件夹  然后在pom.xml里配置

- ```
  <artifactId>mingrui-shop-service</artifactId>
  
  <!--父级项目不需要打包所有packging的类型为pom-->
      <packaging>pom</packaging>
      <modules>
          <module>mingrui-shop-service-xxx</module>
      </modules>
  
      <dependencies>
  
          <!-- SpringBoot-整合Web组件 -->
          <dependency>
              <groupId>org.springframework.boot</groupId>
              <artifactId>spring-boot-starter-web</artifactId>
          </dependency>
  
          <!-- springcloud feign组件 -->
          <dependency>
              <groupId>org.springframework.cloud</groupId>
              <artifactId>spring-cloud-starter-openfeign</artifactId>
          </dependency>
  
          <!--mysql数据库连接-->
          <dependency>
              <groupId>mysql</groupId>
              <artifactId>mysql-connector-java</artifactId>
              <version>5.1.35</version>
          </dependency>
          <!--通用mapper-->
          <dependency>
              <groupId>tk.mybatis</groupId>
              <artifactId>mapper-spring-boot-starter</artifactId>
              <version>2.1.5</version>
          </dependency>
  
          <!--分页工具
          自定义的 mybatis 插件
          mybatis运行原理 mybatis的执行器-->
          <dependency>
              <groupId>com.github.pagehelper</groupId>
              <artifactId>pagehelper-spring-boot-starter</artifactId>
              <version>1.2.10</version>
          </dependency>
  
          <dependency>
              <groupId>com.baidu</groupId>
              <artifactId>mingrui-shop-service-api-xxx</artifactId>
              <version>1.0-SNAPSHOT</version>
          </dependency>
  
      </dependencies>
  ```

   **创建服务接口工程**

- 在mingrui-shop-parent 工程名上右键-->new-->module 

- 项目名为: mingrui-shop-service-api

  删除src文件夹 在pom.xml里配置

  ```
      <!--父级项目不需要打包所有packging的类型为pom-->
      <packaging>pom</packaging>
      
  		<dependencies>
  		
              <!-- SpringBoot-整合Web组件 -->
              <dependency>
                      <groupId>org.springframework.boot</groupId>
                      <artifactId>spring-boot-starter-web</artifactId>
              </dependency>
  		</dependencies>
  ```

  **创建eureka服务**

- 在mingrui-shop-basics工程名上右键-->new-->module

  创建spring-cloud-starter-netflix-eureka-server

- 然后在spring-cloud-starter-netflix-eureka-server下的pom.xml里配置

```
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://maven.apache.org/POM/4.0.0
http://maven.apache.org/xsd/maven-4.0.0.xsd">
	<parent>
        <artifactId>mingrui-shop-basics</artifactId>
        <groupId>com.baidu</groupId>
        <version>1.0-SNAPSHOT</version>
	</parent>
	<modelVersion>4.0.0</modelVersion>
	
	<artifactId>mingrui-shop-basic-eureka-server</artifactId>
	
	<dependencies>
        <!--eureka 服务依赖-->
        <dependency>
            <groupId>org.springframework.cloud</groupId>
            <artifactId>spring-cloud-starter-netflix-eureka-server</artifactId>
		</dependency>
	</dependencies>
</project>



```

​	**2 application.yml**

```
server:
  port: 8761

spring:
  application:
    name: eureka-server

eureka:
  client:
    # eureka服务url,值为map集合默认key为defaultZone
    service-url:
      defaultZone: http://${eureka.instance.hostname}:${server.port}/eureka
    # 当前服务是否同时注册
    register-with-eureka: false
    # 去注册中心获取其他服务的地址
    fetch-registry: false
  instance:
    hostname: localhost
    # 定义服务续约任务（心跳）的调用间隔，单位：秒 默认30
    lease-renewal-interval-in-seconds: 1
    # 定义服务失效的时间，单位：秒 默认90
    lease-expiration-duration-in-seconds: 2
  server:
    # 测试时关闭自我保护机制，保证不可用服务及时踢出
    enable-self-preservation: false
```

**在创建个启动类**

```
import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.cloud.netflix.eureka.server.EnableEurekaServer;
/**
* @ClassName RunEurekaServerApplication
* @Description: TODO
* @Author wangyanjun
* @Date 2020/8/14
* @Version V1.0
**/
@SpringBootApplication
@EnableEurekaServer
public class RunEurekaServerApplication {

	public static void main(String[] args) {
		SpringApplication.run(RunEurekaServerApplication.class);
	}
}
```





# 商品管理

## 一 - 分类管理 （查询）

### 1.1 在mingrui-shop--commons项目下新建mingrui-shop-common-core 项目

#### 1.2 pom.xml

```xml
<!--处理json与各种数据类型或文档类型的转换-->
<dependency> 
    <groupId>com.google.code.gson</groupId> 
    <artifactId>gson</artifactId> 
    <version>2.8.5</version>
</dependency> 
<!--json对象序列化和反序列化的支持--> 
<dependency> 
    <groupId>org.codehaus.jackson</groupId>
    <artifactId>jackson-core-lgpl</artifactId>
    <version>1.9.13</version> 
</dependency> 
<dependency> 
    <groupId>org.codehaus.jackson</groupId>
    <artifactId>jackson-mapper-lgpl</artifactId> 
    <version>1.9.13</version>
</dependency> 

<!--java对象和json对象之间的转换-->
<dependency> 
    <groupId>org.codehaus.jackson</groupId>
    <artifactId>jackson-core-asl</artifactId> 
    <version>1.9.13</version> 
</dependency> 

<dependency> 
    <groupId>org.codehaus.jackson</groupId> 
    <artifactId>jackson-mapper-asl</artifactId>
    <version>1.9.13</version> 
</dependency> 

<!--alibaba的json处理工具--> 
<dependency> 
    <groupId>com.alibaba</groupId>
    <artifactId>fastjson</artifactId> 
    <version>1.2.62</version> 
</dependency> 

<dependency> 
    <groupId>com.fasterxml.jackson.core</groupId> 
    <artifactId>jackson-databind</artifactId>
    <version>2.11.2</version> 
</dependency>
```

#### 1.3新建包com.baidu.shop.utils

#### 1.4  JSONUtil

```java
package com.baidu.shop.utils;

import com.alibaba.fastjson.JSONObject;
import org.codehaus.jackson.JsonParseException;
import org.codehaus.jackson.map.JsonMappingException;
import org.codehaus.jackson.map.ObjectMapper;
import org.codehaus.jackson.type.TypeReference;
import com.google.gson.Gson;
import com.google.gson.GsonBuilder;
import com.google.gson.JsonArray;
import com.google.gson.JsonElement;
import com.google.gson.JsonObject;
import com.google.gson.JsonParser;
import com.google.gson.reflect.TypeToken;
import java.io.FileOutputStream;
import java.io.IOException;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

/**
 * @ClassName JSONUtil
 * @Description: TODO
 * @Author wangyanjun
 * @Date 2020/12/22
 * @Version V1.0
 **/
public class JSONUtil {
    private static Gson gson = null;

    static {
        gson = new GsonBuilder().setDateFormat("yyyy-MM-dd HH:mm:ss").create();
    }

    public static synchronized Gson newInstance() {
        if (gson == null) {
            gson = new GsonBuilder().setDateFormat("yyyy-MM-dd HH:mm:ss").create();
        }
        return gson;
    }

    public static String toJsonString(Object obj) {
        return gson.toJson(obj);
    }


    public static <T> T toBean(String json, Class<T> clz) {
        return gson.fromJson(json, clz);
    }

    public static <T> Map<String, T> toMap(String json, Class<T> clz) {
        Map<String, JsonObject> map = gson.fromJson(json, new
                TypeToken<Map<String, JsonObject>>() {
                }.getType());
        Map<String, T> result = new HashMap<String, T>();
        for (String key : map.keySet()) {
            result.put(key, gson.fromJson(map.get(key), clz));
        }
        return result;
    }

    public static Map<String, Object> toMap(String json) {
        Map<String, Object> map = gson.fromJson(json, new TypeToken<Map<String,
                Object>>() {
        }.getType());
        return map;
    }

    public static <T> List<T> toList(String json, Class<T> clz) {
        JsonArray array = new JsonParser().parse(json).getAsJsonArray();
        List<T> list = new ArrayList<T>();
        for (final JsonElement elem : array) {
            list.add(gson.fromJson(elem, clz));
        }
        return list;
    }


    /**
     * 从json字符串中获取需要的值
     *
     * @param json
     * @param clazz 要转换的类型
     * @return
     */
    public static <T> Object getObjectByKey(String json, Class<T> clazz) {
        if (json != null && !"".equals(json)) {
            return JSONObject.parseObject(json, clazz);
        }
        return null;
    }
    /**
     * 从json字符串中获取需要的值
     *
     * @param json
     * @param clazz 要转换的类型
     * @return
     */
    public static <T> List<T> getListByKey(String json, Class<T> clazz) {
        if (json != null && !"".equals(json)) {
            return JSONObject.parseArray(json, clazz);
        }
        return null;
    }


    /**
     * 从json字符串中获取需要的值
     *
     * @param json
     * @param key
     * 键
     * @return
     */
    public static String getStrByKey(String json, String key) {
        String str = "";
        if (json != null && !"".equals(json)) {
            JSONObject j = JSONObject.parseObject(json);
            if (j.get(key) != null) {
                str = j.get(key).toString();
            }
        }
        return str;
    }


    /**
     * 向文件中写数据
     *
     * @param _sDestFile
     * @param _sContent
     * @throws IOException
     */
    public static void writeByFileOutputStream(String _sDestFile, String
            _sContent) throws IOException {
        FileOutputStream fos = null;
        try {
            fos = new FileOutputStream(_sDestFile);
            fos.write(_sContent.getBytes());
        } catch (Exception ex) {
            ex.printStackTrace();
        } finally {
            if (fos != null) {
                fos.close();
                fos = null;
            }
        }
    }


    /**
     * 非空
     *
     * @param str
     * @return true:不为空 false：空
     */
    public static boolean noEmpty(String str) {
        boolean flag = true;
        if ("".equals(str)) {
            flag = false;
        }
        return flag;
    }


    /**
     * 将"%"去掉
     *
     * @param str
     * @return
     */
    public static double getDecimalByPercentage(String str) {
        double fuse = 0.0;
        if (!"".equals(str) && str != null) {
            if (str.split("%").length > 0) {
                fuse = Double.parseDouble(str.split("%")[0]);
                return fuse;
            }
        }
        return 0.0;
    }


    /**
     * 保留2位小数
     *
     * @param number
     * @return
     */
    public static double ConversionFraction(double number) {
        return Math.floor(number * 100 + 0.5) / 100;
    }
    public static float ConversionM(double number) {
        return (float) JSONUtil.ConversionFraction(number / 1024 / 1024);
    }

    public static String getErrorText(String s) {
        JSONObject j = JSONObject.parseObject(s);
        return
                j.getJSONObject(j.keySet().iterator().next()).get("errortext").toString();
    }

    public static String getSingleJobId(String s) throws Exception {
        JSONObject j = JSONObject.parseObject(s);
        try {
            return
                    j.getJSONObject(j.keySet().iterator().next()).get("jobid").toString();
        } catch (Exception e) {
            try {
                return
                        j.getJSONObject(j.keySet().iterator().next()).get("errortext").toString();
            } catch (Exception e1) {
                throw new Exception(e1.getMessage());
            }
        }
    }

    public static <T> T readValue(String jsonStr, TypeReference type)
            throws JsonParseException, JsonMappingException, IOException {
        ObjectMapper mapper = new ObjectMapper();
        return mapper.readValue(jsonStr, type);
    }
    public static JSON_TYPE getJSONType(String str) {
        if (null == str || "".equals(str)) {
            return JSON_TYPE.JSON_TYPE_ERROR;
        }
        final char[] strChar = str.substring(0, 1).toCharArray();
        final char firstChar = strChar[0];
        if (firstChar == '{') {
            return JSON_TYPE.JSON_TYPE_OBJECT;
        } else if (firstChar == '[') {
            return JSON_TYPE.JSON_TYPE_ARRAY;
        } else {
            return JSON_TYPE.JSON_TYPE_ERROR;
        }
    }

    public enum JSON_TYPE {
        /** JSONObject */
        JSON_TYPE_OBJECT,
        /** JSONArray */
        JSON_TYPE_ARRAY,
        /** 不是JSON格式的字符串 */
        JSON_TYPE_ERROR
    }

}

```

#### 1.5 新建包com.baidu.shop.status

#### 1.6 HTTPStatus

```java
package com.baidu.shop.status;

/**
 * @ClassName HTTPStatus
 * @Description: TODO
 * @Author wangyanjun
 * @Date 2020/12/22
 * @Version V1.0
 **/
public class HTTPStatus {
    public static final int OK = 200;  // 成功

    public static final int ERROR = 500; // 失败

    public static final int OPERATION_ERROR = 5001;//操作失败

    public static final int PARAMS_VALIDATE_ERROR = 5002;//参数校验失败

}

```

##### **1.7** 新建包com.baidu.shop.base

##### 1.8  创建 Result

```java
package com.baidu.shop.base;

import lombok.Data;
import lombok.NoArgsConstructor;

/**
 * @ClassName Result
 * @Description: TODO
 * @Author wangyanjun
 * @Date 2020/12/22
 * @Version V1.0
 **/
@Data
@NoArgsConstructor
public class Result<T> {
    private  Integer code; // 返回码

    private String message ; // 返回消息

    private T data; // 返回数据

    public Result(Integer code, String message, Object data) {
        this.code = code;
        this.message = message;
        this.data = (T) data;
    }

}

```

##### BaseApiService

```java
package com.baidu.shop.base;

import com.baidu.shop.status.HTTPStatus;
import com.baidu.shop.utils.JSONUtil;
import lombok.Data;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Component;

/**
 * @ClassName BaseApiService
 * @Description: TODO
 * @Author wangyanjun
 * @Date 2020/12/22
 * @Version V1.0
 **/
@Data
@Component
@Slf4j
public class BaseApiService<T>{

    public Result<T> setResultError(Integer code, String msg) {
        return setResult(code, msg, null);
    }
    // 返回错误，可以传msg
    public Result<T> setResultError(String msg) {
        return setResult(HTTPStatus.ERROR, msg, null);
    }
    // 返回成功，可以传data值
    public Result<T> setResultSuccess(T data) {
        return setResult(HTTPStatus.OK, HTTPStatus.OK + "", data);
    }
    // 返回成功，沒有data值
    public Result<T> setResultSuccess() {
        return setResult(HTTPStatus.OK, HTTPStatus.OK + "", null);
    }
    // 返回成功，沒有data值
    public Result<T> setResultSuccess(String msg) {
        return setResult(HTTPStatus.OK, msg, null);
    }
    // 通用封装
    public Result<T> setResult(Integer code, String msg, T data) {
        log.info(String.format("{code : %s , message : %s , data : %s}",code,msg,
                JSONUtil.toJsonString(data)));
        return new Result<T>(code, msg, data);
    }


}
```



#### 2.0  service-api工程

##### 2.0.1  mingrui-shop-service-api/pom.xml

```xml
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <parent>
        <artifactId>mingrui-shop-parent</artifactId>
        <groupId>com.baidu</groupId>
        <version>1.0-SNAPSHOT</version>
    </parent>
    <modelVersion>4.0.0</modelVersion>

    <artifactId>mingrui-shop-service-api</artifactId>

    <!--父级项目不需要打包所有packging的类型为pom-->
    <packaging>pom</packaging>
    <modules>
        <module>mingrui-shop-service-api-xxx</module>
    </modules>
    <dependencies>

        <!--分页工具-->
        <dependency>
            <groupId>com.github.pagehelper</groupId>
            <artifactId>pagehelper-spring-boot-starter</artifactId>
            <version>1.2.10</version>
        </dependency>

        <!-- SpringBoot-整合Web组件 -->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-web</artifactId>
        </dependency>

        <!--Entity 中的@Table 和@Id需要次注解-->
        <dependency>
            <groupId>javax.persistence</groupId>
            <artifactId>persistence-api</artifactId>
            <version>1.0.2</version>
        </dependency>
        <!--2.3版本之后web删除了验证插件-->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-validation</artifactId>
        </dependency>
        <!--引入common工程代码-->
        <dependency>
            <groupId>com.baidu</groupId>
            <artifactId>mingrui-shop-common-core</artifactId>
            <version>1.0-SNAPSHOT</version>
        </dependency>

    </dependencies>

</project>
```



#### 2.0.2  在 mingrui-shop-service-api项目下新建mingrui-shop-service-api-xxx项目

#### 2.0.3 pom.xml

```xml
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <parent>
        <artifactId>mingrui-shop-service-api</artifactId>
        <groupId>com.baidu</groupId>
        <version>1.0-SNAPSHOT</version>
    </parent>
    <modelVersion>4.0.0</modelVersion>

    <artifactId>mingrui-shop-service-api-xxx</artifactId>

    <dependencies>
        <!--帮助开发人员快速生成API文档-->
        <dependency>
            <groupId>io.springfox</groupId>
            <artifactId>springfox-swagger2</artifactId>
            <version>2.9.2</version>
        </dependency>
        <!--提供可视化的API文档-->
        <dependency>
            <groupId>io.springfox</groupId>
            <artifactId>springfox-swagger-ui</artifactId>
            <version>2.9.2</version>
        </dependency>

    </dependencies>
</project>
```



#### 2.0.4  新建包 com.baidu.shop.entity

#### 2.0.5    CategoryEntity

```java
package com.baidu.shop.entity;

import com.baidu.shop.validate.group.MingruiOperation;
import io.swagger.annotations.ApiModel;
import io.swagger.annotations.ApiModelProperty;
import lombok.Data;

import javax.persistence.Id;
import javax.persistence.Table;
import javax.validation.constraints.NotEmpty;
import javax.validation.constraints.NotNull;

/**
 * @ClassName CategoryEntity
 * @Description: TODO
 * @Author wangyanjun
 * @Date 2020/12/22
 * @Version V1.0
 **/
@ApiModel(value = "分类实体类")
@Data
@Table(name="tb_category")
public class CategoryEntity {

    @Id
    @ApiModelProperty(value ="类目id", example = "1")
    @NotNull(message = "ID不能为空",groups = {MingruiOperation.Update.class})
    private Integer id;


    @ApiModelProperty(value ="类目名称")
    @NotEmpty(message = "类目名称不能为空",groups = {MingruiOperation.Update.class,MingruiOperation.Add.class})
    private String name;

    @ApiModelProperty(value ="父类目id,顶级类目填0", example = "1")
    @NotNull(message = "父类目ID不能为Null",groups = {MingruiOperation.Add.class})
    private Integer parentId;

    @ApiModelProperty(value ="是否为父节点，0为否，1为是", example = "1")
    @NotNull(message = "是否为父节点不能为Null",groups = {MingruiOperation.Add.class})
    private Integer isParent;

    @ApiModelProperty(value ="排序指数，越小越靠前", example = "1")
    @NotNull(message = "父类目ID不能为空",groups = {MingruiOperation.Add.class})
    private Integer sort;
}

```

#### 2.0.6  swagger2的配置   新建包com.baidu.shop.config

```java
package com.baidu.shop.config;

import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import springfox.documentation.builders.ApiInfoBuilder;
import springfox.documentation.builders.PathSelectors;
import springfox.documentation.builders.RequestHandlerSelectors;
import springfox.documentation.service.ApiInfo;
import springfox.documentation.service.Contact;
import springfox.documentation.spi.DocumentationType;
import springfox.documentation.spring.web.plugins.Docket;
import springfox.documentation.swagger2.annotations.EnableSwagger2;

/**
 * @ClassName MrSwagger2Config
 * @Description: TODO
 * @Author wangyanjun
 * @Date 2020/12/22
 * @Version V1.0
 **/
@Configuration
@EnableSwagger2
public class MrSwagger2Config {

    @Bean
    public Docket createRestApi() {
        return new Docket(DocumentationType.SWAGGER_2)
                .apiInfo(this.apiInfo()).select()
                .apis(RequestHandlerSelectors.basePackage("com.baidu"))
                .paths(PathSelectors.any())
                .build();
    }

    private ApiInfo apiInfo(){
        return new ApiInfoBuilder()
                //标题
                .title("明瑞SWAGGER2标题")
                //条款地址
                .termsOfServiceUrl("http://www.baidu.com")
                //联系方式-->有String参数的方法但是已经过时，所以不推荐使用
                .contact(new Contact("wangyanjun","baidu.com","wangyanjun_Jay@163.com"))
                //版本
                .version("v1.0")
                //项目描述
                .description("描述")
                //创建API基本信息
                .build();
    }

}

```



#### 2.0.7  定义商品分类接口 CategoryService

```java
package com.baidu.shop.service;


import com.baidu.shop.base.Result;
import com.baidu.shop.entity.CategoryEntity;
import com.baidu.shop.validate.group.MingruiOperation;
import com.google.gson.JsonObject;
import io.swagger.annotations.Api;
import io.swagger.annotations.ApiOperation;
import org.springframework.validation.annotation.Validated;
import org.springframework.web.bind.annotation.*;

import java.util.List;

/**
 * @ClassName CategoryService
 * @Description: TODO
 * @Author wangyanjun
 * @Date 2020/12/22
 * @Version V1.0
 **/
@Api(tags = "商品分类接口")
public interface CategoryService {

    @ApiOperation(value = "通过查询商品分类")
    @GetMapping(value = "category/list")
    Result<List<CategoryEntity>> getCategoryByPid(Integer pid);

}

```



#### 2.1 service工程

##### 2.1.1 mingrui-shop-service/pom.xml

```xml
<dependencies>
        <!-- SpringBoot-整合Web组件 -->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-web</artifactId>
        </dependency>
        <!-- springcloud feign组件 -->
        <dependency>
            <groupId>org.springframework.cloud</groupId>
            <artifactId>spring-cloud-starter-openfeign</artifactId>
        </dependency>

        <!--mysql数据库连接-->
        <dependency>
            <groupId>mysql</groupId>
            <artifactId>mysql-connector-java</artifactId>
            <version>5.1.30</version>
            <scope>runtime</scope><!--项目运行阶段使用-->
        </dependency>
        <!--通用mapper-->
        <dependency>
            <groupId>tk.mybatis</groupId>
            <artifactId>mapper-spring-boot-starter</artifactId>
            <version>2.1.5</version>
        </dependency>
        <!--分页工具-->
        <dependency>
            <groupId>com.github.pagehelper</groupId>
            <artifactId>pagehelper-spring-boot-starter</artifactId>
            <version>1.2.10</version>
        </dependency>
        <dependency>
            <groupId>com.baidu</groupId>
            <artifactId>mingrui-shop-service-api-xxx</artifactId>
            <version>1.0-SNAPSHOT</version>
        </dependency>

    </dependencies>

```



##### **2.1.2** 在mingrui-shop-service工程下新建mingrui-shop-service-xxx工程

##### 2.1.3  application.yml

```yml
server:
  port: 8100

spring:
  application:
      name: xxx-server
      # 配置数据源
  datasource:
    # 数据源名称，任意
    name: mysql
    url: jdbc:mysql://localhost:3306/2005?useSSL=true&nullNamePatternMatchesAll=true&serverTimezone=GMT%2B8&useUnicode=true&characterEncoding=utf8
    # 数据库连接用户
    username: root
    # 数据库连接密码
    password: root
    # 驱动名称
    driver-class-name: com.mysql.jdbc.Driver
    # boot2.0+使用hikari作为默认数据库连接池
    type: com.zaxxer.hikari.HikariDataSource
    hikari:
      # 是否自动提交事务 默认
      auto-commit: true
      # 允许的最小连接数
      minimum-idle: 5
      # 连接池内最大连接数
      maximum-pool-size: 10
      # 验证连接的sql语句
      connection-test-query: SELECT 1 FROM DUAL
      # 连接超时时间 默认30000 毫秒 如果小于250毫秒，则被重置回30秒
      connection-timeout: 30000
      # 验证超时时间默认5000毫秒 如果小于250毫秒，则会被重置回5秒
      validation-timeout: 5000
      # 设置连接在连接池中的存货时间 如果不等于0且小于30秒则会被重置回30分钟
      max-lifetime: 1800000

# 通用mapper
mapper:
  mappers: tk.mybatis.mapper.common.Mapper
  identity: MYSQL
  #日志设置
logging:
  level:
    # 打印与我们程序相关的日志信息
    com.baidu.shop: debug
# eureka配置
eureka:
  client:
    service-url:
      defaultZone: http://localhost:8761/eureka/
```



#### 2.1.4 新建包 com.baidu 

#### 2.1.5   新建  启动类 RunXXXApplication

```java
package com.baidu;
import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.cloud.netflix.eureka.EnableEurekaClient;
import tk.mybatis.spring.annotation.MapperScan;
/**
 * @ClassName RunXXXApplication
 * @Description: TODO
 * @Author wangyanjun
 * @Date 2020/12/22
 * @Version V1.0
 **/
@SpringBootApplication
@EnableEurekaClient
@MapperScan("com.baidu.shop.mapper")
public class RunXXXApplication {
    public static void main(String[] args) {
        SpringApplication.run(RunXXXApplication.class);
    }
}

```



#### 2.1.6 在com.baidu下新建包shop.mapper

#### 2.1.7   创建 mapper  CategoryMapper

```java
package com.baidu.shop.mapper;

import com.baidu.shop.entity.CategoryEntity;
import org.apache.ibatis.annotations.Select;
import tk.mybatis.mapper.common.Mapper;

import java.util.List;

/**
 * @ClassName CategoryMapper
 * @Description: TODO
 * @Author wangyanjun
 * @Date 2020/12/22
 * @Version V1.0
 **/
public interface CategoryMapper extends Mapper<CategoryEntity> {


}

```



#### 2.1.8 在com.baidu下新建包shop.service.impl

#### 2.1.9  新建实现类 CategoryServiceImpl

```java
package com.baidu.shop.service.impl;

import com.baidu.shop.base.BaseApiService;
import com.baidu.shop.base.Result;
import com.baidu.shop.entity.CategoryBrandEntity;
import com.baidu.shop.entity.CategoryEntity;
import com.baidu.shop.mapper.CategoryBrandMapper;
import com.baidu.shop.mapper.CategoryMapper;
import com.baidu.shop.service.CategoryService;
import com.baidu.shop.utils.ObjectUtil;
import com.google.gson.JsonObject;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.transaction.annotation.Transactional;
import org.springframework.web.bind.annotation.RestController;
import tk.mybatis.mapper.entity.Example;

import javax.annotation.Resource;
import java.util.List;

/**
 * @ClassName CategoryServiceImpl
 * @Description: TODO
 * @Author wangyanjun
 * @Date 2020/12/22
 * @Version V1.0
 **/
@RestController
public class CategoryServiceImpl extends BaseApiService implements CategoryService {

    @Autowired
    private CategoryMapper categoryMapper;

    @Resource
    private CategoryBrandMapper categoryBrandMapper;

    @Override
    public Result<List<CategoryEntity>> getCategoryByPid(Integer pid) {

        //    System.out.println(1/0);
        CategoryEntity categoryEntity = new CategoryEntity();
        categoryEntity.setParentId(pid);
        List<CategoryEntity> list = categoryMapper.select(categoryEntity);
        return this.setResultSuccess(list);
    }


}

```



#####   浏览器 访问   输入 http://localhost:8100/category/list



#### 2.2 网关 服务

#### 2.2.1 在mingrui-shop-basic项目下新建mingrui-shop-basic-zuul-server

##### pm.xml

```xml
<dependencies> 
    <!-- zuul -->
    <dependency> 
    <groupId>org.springframework.cloud</groupId> 
    <artifactId>spring-cloud-starter-netflix-zuul</artifactId> 
    </dependency>
</dependencies>
```



##### application.yml

```yml
server:
  port: 8088

spring:
  application:
    name: eureka-zuul

zuul:
  # 声明路由
  routes:
  # 路由名称
    api-xxx:
    # 声明将所有以/api-ribbon/的请求都转发到eureka-ribbon的服务中
      path: /api-xxx/**
      serviceId: xxx-server
  # 启用重试
  retryable: true
  # 包含此路径的不进行路由
  ignored-patterns: /upload/**
  # 忽略上传服务
  ignored-services:
    -upload-server

#配置负载
ribbon:
  ConnectTimeout: 10000 # 连接超时时间(ms)
  ReadTimeout: 10000 # 通信超时时间(ms)
  OkToRetryOnAllOperations: true # 是否对所有操作重试
  MaxAutoRetriesNextServer: 2 # 同一服务不同实例的重试次数
  MaxAutoRetries: 1 # 同一实例的重试次数


hystrix:
  command:
    default:
      execution:
        isolation:
          thread:
            timeoutInMilliseconds: 10000 # 熔断超时时长：6000ms



eureka:
  client:
    service-url:
      defaultZone: http://localhost:8761/eureka/
```





#### 2.2.2 新建包com.baidu 

##### 新建启动类 

```java
package com.baidu;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.cloud.netflix.eureka.EnableEurekaClient;
import org.springframework.cloud.netflix.zuul.EnableZuulProxy;

/**
 * @ClassName RunZuulServerApplication
 * @Description: TODO
 * @Author wangyanjun
 * @Date 2020/12/23
 * @Version V1.0
 **/
@SpringBootApplication
@EnableZuulProxy
@EnableEurekaClient
public class RunZuulServerApplication {
    public static void main(String[] args) {
        SpringApplication.run(RunZuulServerApplication.class);
    }
}

```



#### 2.2.3   在com.baidu下新建 global.GlobalCorsConfig

```java
package com.baidu.global;

import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.web.cors.CorsConfiguration;
import org.springframework.web.cors.UrlBasedCorsConfigurationSource;
import org.springframework.web.filter.CorsFilter;
/**
 * @ClassName GlobalCorsConfig
 * @Description: TODO
 * @Author wangyanjun
 * @Date 2020/12/23
 * @Version V1.0
 **/
@Configuration
public class GlobalCorsConfig {

    @Bean
    public CorsFilter corsFilter() {
        final UrlBasedCorsConfigurationSource source = new UrlBasedCorsConfigurationSource();
        final CorsConfiguration config = new CorsConfiguration();
        config.setAllowCredentials(true); // 允许cookies跨域
        config.addAllowedOrigin("*");// 允许向该服务器提交请求的URI，*表示全部允许。。这里尽量限制来源域，比如http://xxxx:8080 ,以降低安全风险。。
        config.addAllowedHeader("*");// 允许访问的头信息,*表示全部
        config.setMaxAge(18000L);// 预检请求的缓存时间（秒），即在这个时间段里，对于相同的跨域请求不会再预检了
        config.addAllowedMethod("*");// 允许提交请求的方法，*表示全部允许，也可以单独设置GET、PUT等
        config.addAllowedMethod("HEAD");
        config.addAllowedMethod("GET");// 允许Get的请求方法
        config.addAllowedMethod("PUT");
        config.addAllowedMethod("POST");
        config.addAllowedMethod("DELETE");
        config.addAllowedMethod("PATCH");
        source.registerCorsConfiguration("/**", config);
        //3.返回新的CorsFilter.
        return new CorsFilter(source);
   }
}
```



#### 2.2.4  前端 vue 项目 

##### 2.2.4.1  Category.vue   line： 4 



```
  <v-flex xs12 sm10>
        <v-tree url="/category/list"  //  改为自己的请求地址
                :isEdit="isEdit"
                :key="key"
                @handleAdd="handleAdd"
                @handleEdit="handleEdit"
                @handleDelete="handleDelete"
                @handleClick="handleClick"
        />
      </v-flex>
```



##### 2.2.4.2 Tree.vue

```
<template>
  <v-list class="pt-0 pb-0" dense>
    <TreeItem
      class="item" :model="model" v-for="(model, index) in db" :key="index"
      :url="url"
      :isEdit="isEdit"
      :nodes="nodes"
      @handleAdd="handleAdd"
      @handleEdit="handleEdit"
      @handleDelete="handleDelete"
      @handleClick="handleClick"
    />
  </v-list>
</template>

<script>
  import TreeItem from './TreeItem';

  export default {
    name: "vTree",
    props: {
      url: String,
      isEdit: {
        type: Boolean,
        default: false
      },
      treeData:{
        type:Array
      }
    },
    data() {
      return {
        db: [],
        nodes:{
          opened:null,
          selected:{isSelected:false}
        }
      }
    },
    components: {
      TreeItem
    },
    created() {
      if(this.treeData && this.treeData.length > 0){
        this.db = this.treeData;
        return;
      }
      this.getData();
    },
    methods: {
      getData() {
        this.$http.get(this.url, {params: {pid: 0}}).then(resp => {
          console.log(resp);
          this.db = resp.data.data;
          this.db.forEach(n => n['path'] = [n.name])
        })
      },
      handleAdd(node) {
        this.$emit("handleAdd", this.copyNodeInfo(node));
      },
      handleEdit(id, name) {
        this.$emit("handleEdit", id, name)
      },
      handleDelete(id) {
        this.deleteById(id, this.db);
        this.$emit("handleDelete", id);
      },
      handleClick(node){
        this.$emit("handleClick", this.copyNodeInfo(node))
      },
      // 根据id删除
      deleteById(id, arr) {
        let src = arr || this.db;
        for (let i in src) {
          let d = src[i];
          if (d.id === id) {
            src.splice(i, 1)
            return;
          }
          if (d.children && d.children.length > 0) {
            this.deleteById(id, d.children)
          }
        }
      },
      copyNodeInfo(node){
        const o = {};
        for(let i in node){
          o[i] = node[i];
        }
        return o;
      }
    },
    watch: {}
  }
</script>

<style scoped>
  .item {
    cursor: pointer;
  }
</style>

```

##### 2.2.4.3 TreeItem.vue    line： 121 

```
<template>
  <div>
    <v-list-tile
      @click="toggle" class="level1 pt-0 pb-0 mt-0 mb-0" :class="{'selected':isSelected}">
      <v-list-tile-avatar>
        <v-icon v-if="model.isParent">{{open ? 'folder_open' : 'folder'}}</v-icon>
        <v-icon v-if="!model.isParent">insert_drive_file</v-icon>
      </v-list-tile-avatar>
      <v-list-tile-content>
        <v-list-tile-title v-show="!beginEdit">
          <span >{{model.name}}</span>
        </v-list-tile-title>
        <input v-show="beginEdit" @click.stop="" :ref="model.id" v-model="model.name"
               @blur="afterEdit" @keydown.enter="afterEdit"/>
      </v-list-tile-content>
      <v-list-tile-action v-if="isEdit">
        <v-btn icon @mouseover="c1='primary'" @mouseout="c1=''" :color="c1" @click.stop="addChild">
          <i class="el-icon-plus"/>
        </v-btn>
      </v-list-tile-action>
      <v-list-tile-action v-if="isEdit">
        <v-btn icon @mouseover="c2='success'" @mouseout="c2=''" :color="c2" @click.stop="editChild">
          <i class="el-icon-edit"/>
        </v-btn>
      </v-list-tile-action>
      <v-list-tile-action v-if="isEdit">
        <v-btn icon @mouseover="c3='error'" @mouseout="c3=''" :color="c3" @click.stop="deleteChild">
          <i class="el-icon-delete"/>
        </v-btn>
      </v-list-tile-action>
    </v-list-tile>

    <v-list v-if="isFolder" v-show="open" class="ml-4 pt-0 pb-0" dense transition="scale-transition">
      <tree-item
        class="item"
        v-for="(model, index) in model.children"
        :key="index"
        :model="model"
        :url="url"
        :isEdit="isEdit"
        :nodes="nodes"
        :parentState="open"
        @handleAdd="handleAdd"
        @handleEdit="handleEdit"
        @handleDelete="handleDelete"
        @handleClick="handleClick"
      >
      </tree-item>
    </v-list>
  </div>
</template>

<script>
  import Vue from 'vue'

  export default {
    name: "tree-item",
    props: {
      model: Object,
      url: String,
      isEdit: {
        type: Boolean,
        default: false
      },
      nodes: Object,
      parentState:Boolean
    },
    created() {
    },
    data: function () {
      return {
        c1: '',
        c2: '',
        c3: '',
        isSelected: false,
        open:false,
        beginEdit:false
      }
    },
    watch:{
      parentState(val){
        if(!val){
          this.open = val;
        }
      }
    },
    computed: {
      isFolder: function () {
        return this.model.children &&
          this.model.children.length > 0
      }
    },
    methods: {
      toggle: function () {
        // 将其它被选中项取消选中
        this.nodes.selected.isSelected = false;
        // 当前项被选中
        this.isSelected = true;
        // 保存当前选中项
        this.nodes.selected = this

        // 客户自己的点击事件回调
        this.handleClick(this.model);

        // 判断是否为顶级节点，顶级节点需要记录和替换
        if(this.model.parentId == 0){
          // 判断打开节点是否是自己
          if(this.nodes.opened && this != this.nodes.opened){
            // 不是，则关闭原来的节点
            this.nodes.opened.open = false;
          }
          // 将自己记录为打开的节点
          this.nodes.opened = this;
        }
        // 切换开闭状态
        this.open = !this.open;
        // 如果已经是叶子节点,或者自己是关闭的，或者自己已经有儿子了，结束
        if (!this.model.isParent || this.isFolder || !this.open) {
          return;
        }
        // 展开后查询子节点
        this.$http.get(this.url, {params: {pid: this.model.id}})
          .then(resp => {
          Vue.set(this.model, 'children', resp.data.data);
          // 封装当前节点的路径
          this.model.children.forEach(n => {
            n['path'] = [];
            this.model.path.forEach(p => n['path'].push(p));
            n['path'].push(n.name);
          });
        }).catch( e => {
          console.log(e);
        });
      },
      addChild: function () {
        let child = {
          id: 0,
          name: '新的节点',
          parentId: this.model.id,
          isParent: false,
          sort:this.model.children? this.model.children.length + 1:1
        }
        if (!this.model.isParent) {
          Vue.set(this.model, 'children', [child]);
          this.model.isParent = true;
          this.open = true;
          this.handleAdd(child);
        } else {
          if (!this.isFolder) {
            this.$http.get(this.url, {params: {pid: this.model.id}}).then(resp => {
              Vue.set(this.model, 'children', resp.data);
              this.model.children.push(child);
              this.open = true;
              this.handleAdd(child);
            });
          } else {
            this.model.children.push(child);
            this.open = true;
            this.handleAdd(child);
          }
        }
      },
      deleteChild: function () {
        if (this.model.isParent == 1) {
          this.$message.warning("当前节点为父节点，不能删除")
          return;
        }
        this.$message.confirm('此操作将永久删除数据，是否继续?', '提示', {
          confirmButtonText: '确定删除',
          cancelButtonText: '取消',
          type: 'warning'
        }).then(() => {
          this.handleDelete(this.model.id);
        }).catch(()=>{
          this.$message.info('已取消删除');
        })

      },
      editChild() {
        this.beginEdit = true;
        this.$nextTick(() => this.$refs[this.model.id].focus());
      },
      afterEdit() {
        if (this.beginEdit) {//this.model.beginEdit
          this.beginEdit = false;
          this.handleEdit(this.model.id, this.model.name);
        }
      },
      handleAdd(node) {
        this.$emit("handleAdd", node);
      },
      handleDelete(id) {
        this.$emit("handleDelete", id);
      },
      handleEdit(id, name) {
        this.$emit("handleEdit", id, name)
      },
      handleClick(node) {
        this.$emit("handleClick", node);
      }
    }
  }
</script>

<style scoped>
  .level1 {
    height: 40px;
  }

  .selected {
    background-color: rgba(105,184,249,0.75);
  }
</style>

```

依次启动后端 eureka-server,xxx-service,zuul-server,vue项目

浏览器访问  http://manage.mrshop.com/

### 3.0 商品分类  删除 

前台 vue项目 

#### 3.1TreeItem.vue    line： 164 

```
deleteChild: function () {
        if (this.model.isParent == 1) {
          this.$message.warning("当前节点为父节点，不能删除")
          return;
        }
        this.$message.confirm('此操作将永久删除数据，是否继续?', '提示', {
          confirmButtonText: '确定删除',
          cancelButtonText: '取消',
          type: 'warning'
        }).then(() => {
          this.handleDelete(this.model.id);
        }).catch(()=>{
          this.$message.info('已取消删除');
        })
      },
```

#### 3.2 Category.vue

```vue
   <v-tree url="/category/list"
       :isEdit="isEdit"
       :key="key"
       @handleAdd="handleAdd"
       @handleEdit="handleEdit"
       @handleDelete="handleDelete"
       @handleClick="handleClick"
       />
     </v-flex>
 
  data() {
      return {
        isEdit:true,
        key:0  // 用来刷新
      }
    },
 

 handleDelete(id) {
        console.log("delete ... " + id)
        this.$http.delete('/category/del?id='+id).then(resp =>{
          if (resp.data.code != 200) {
            this.$message.error("删除失败"+resp.data.message);
           // this.key = new Date().getTime();
            return;
          }
          this.$message.success('删除成功');
             this.key= new Date().getTime();  //  删除后刷新
        }).catch(error => console.error("error"))
      },
```

后台 **mingrui-shop-service-api-xxx** 下   **CategoryService**

```
@ApiOperation(value = "通过id删除分类") 
@DeleteMapping(value = "category/del") 
Result<JsonObject> delCategory(Integer id);
```



#### 在  **mingrui-shop-common-core**  下 新建工具类 ObjectUtil

```java
package com.baidu.shop.utils;
/**
 * @ClassName ObjectUtil
 * @Description: TODO
 * @Author wangyanjun
 * @Date 2020/12/23
 * @Version V1.0
 **/
public class ObjectUtil {

    public static Boolean isNull(Object obj){
        return obj == null ;
    }
    public static Boolean isNotNull(Object obj){
        return obj != null ;
    }
}

```

####  **mingrui-shop-service-xxx** 

```java
 @Transactional  //作用提交事务      增删改查必须加这个
    @Override
    public Result<JsonObject> delCategory(Integer id) {

        //校验id是否合法
        if(ObjectUtil.isNull(id) || id <= 0 ){
            return this.setResultError("id不合法");
        }
        CategoryEntity categoryEntity = categoryMapper.selectByPrimaryKey(id);

        if(ObjectUtil.isNull(categoryEntity)){
            return this.setResultError("数据不存在");
        }
        //判断当前节点是否为父节点
        if(categoryEntity.getIsParent() == 1) {
            return this.setResultError("当前节点为父节点");
        }

        Example example1 = new Example(CategoryBrandEntity.class);
        example1.createCriteria().andEqualTo("categoryId",id);
        List<CategoryBrandEntity> categoryBrandEntities = categoryBrandMapper.selectByExample(example1);
        if(categoryBrandEntities.size() != 0 ){
            return this.setResultError("已绑定不能被删除");
        }

        //通过当前节点的父节点id 查询 当前节点(将要被删除的节点)的父节点下是否还有其他子节点
        Example example = new Example(CategoryEntity.class);
        example.createCriteria().andEqualTo("parentId",categoryEntity.getParentId());

        List<CategoryEntity> categoryList  = categoryMapper.selectByExample(example);

        //如果size <= 1 --> 如果当前节点被删除的话 当前节点的父节点下没有节点了 --> 将当前节点的父节点状态改为叶子节点
        if(categoryList.size() <= 1){
            CategoryEntity updateCategoryEntity  = new CategoryEntity();
            updateCategoryEntity.setIsParent(0);
            updateCategoryEntity.setId(categoryEntity.getParentId());
            categoryMapper.updateByPrimaryKeySelective(updateCategoryEntity);
        }
        //通过id删除节点
        categoryMapper.deleteByPrimaryKey(id);
        return this.setResultSuccess();
    }
```

#### 4.0  商品分类  新增和 修改

##### 4.0.1 **TreeItem.vue**    和  **Category.vue** 

```
   	afterEdit() {
        if (this.beginEdit) {//this.model.beginEdit
          this.beginEdit = false;
          this.handleEdit(this.model.id, this.model.name);
        }
      },
      
       handleAdd(node) {
        delete node.id;
        node.isParent = node.isParent?1:0
        console.log(node)
        this.$http.post('/category/save',node).then(resp =>{
            if(resp.data.code != 200){
              this.$message.error("新增失败"+resp.data.message)
            }
            this.$message.success("新增成功")
            this.key = new Date().getTime();
        }).catch(error => console.error("error"))
      },
      
```

##### 4.0.2 **Category.vue**  line ： 38 

```
 handleEdit(id, name) {
        this.$http.put('/category/edit',{
          id:id,
          name:name
        }).then(resp =>{
          if (resp.data.code != 200) {
            this.$message.error("修改失败"+resp.data.message)
            return
          }
          this.key = new Date().getTime()
          this.$message.success("修改成功")
        }).catch(error => console.error("error"))
      },
```

##### 4.0.3    **mingrui-shop-service-api- xxx**   

##### CategoryService

```java
//category/edit
@ApiOperation(value = "更新")
@PutMapping(value = "category/edit")
Result<JsonObject> editCategory(@Validated({MingruiOperation.Update.class}) @RequestBody CategoryEntity categoryEntity);

 // /category/save  添加
@ApiOperation(value = "新增分类")
@PostMapping(value = "category/save")
Result<JsonObject> add(@Validated({MingruiOperation.Add.class}) @RequestBody CategoryEntity categoryEntity);

```

##### 4.0.4  **mingrui-shop-service-xxx** 

```
   //修改 的
    @Transactional  //作用提交事务      增删改查必须加这个
    @Override
    public Result<JsonObject> editCategory(CategoryEntity categoryEntity) {

        categoryMapper.updateByPrimaryKeySelective(categoryEntity);
        return this.setResultSuccess();
    }
    
     // 新增分类
    @Transactional 
    @Override
    public Result<JsonObject> add(CategoryEntity categoryEntity) {
        CategoryEntity parentCategoryEntity  = new CategoryEntity();
        parentCategoryEntity.setId(categoryEntity.getParentId());
        parentCategoryEntity.setIsParent(1);
        categoryMapper.updateByPrimaryKeySelective(parentCategoryEntity);

        categoryMapper.insertSelective(categoryEntity);

        return this.setResultSuccess();
    }
    

```











## 二 - 品牌管理

#### 1.1 vue项目

##### 1.1.1 官网地址: 表格:https://v15.vuetifyjs.com/zh-Hans/components/data-tables 

##### 							输入框:https://v15.vuetifyjs.com/zh-Hans/components/snackbars 

##### 							按钮:https://v15.vuetifyjs.com/zh-Hans/components/buttons



##### 1.2 在item包下新建MrBrand.vue

```js
<template>
  <v-card>
    <v-card-title>
      <v-btn @click="addBrand" color="primary">新增品牌</v-btn>
      <v-spacer/>
      <v-text-field
        append-icon="search"
        label="搜索"
        single-line
        hide-details
        v-model="search"
      />
    </v-card-title>
    <v-divider/>
    <v-data-table
      :headers="headers"
      :items="items"
      :pagination.sync="pagination"
      :total-items="totalItems"
      :loading="loading"
      class="elevation-1"
    >
      <template slot="items" slot-scope="props">
        <td class="text-xs-center">{{ props.item.id }}</td>
        <td class="text-xs-center">{{ props.item.name }}</td>
        <td class="text-xs-center"><img v-if="!!props.item.image" width="102" height="36" :src="props.item.image"/></td>
        <td class="text-xs-center">{{ props.item.letter }}</td>
        <td class="justify-center layout px-0">
          <v-btn icon @click="editBrand(props.item)">
            <i class="el-icon-edit"/>
          </v-btn>
          <v-btn icon @click="deleteBrand(props.item)">
            <i class="el-icon-delete"/>
          </v-btn>
        </td>
      </template>
      <template slot="expand" slot-scope="props">
        <v-card flat>
          <v-card-text>Peek-a-boo!</v-card-text>
        </v-card>
      </template>
      <template slot="no-data">
        <v-alert :value="true" color="error" icon="warning">
          对不起，没有查询到任何数据 :(
        </v-alert>
      </template>
      <template slot="pageText" slot-scope="props">
        共{{props.itemsLength}}条,当前:{{ props.pageStart }} - {{ props.pageStop }}
      </template>
    </v-data-table>

    <v-dialog v-model="show" max-width="600" scrollable v-if="show">
      <v-card>
        <v-toolbar dark dense color="primary">
          <v-toolbar-title>{{isEdit ? '修改品牌' : '新增品牌'}}</v-toolbar-title>
          <v-spacer/>
          <v-btn icon @click="show = false">
            <v-icon>close</v-icon>
          </v-btn>
        </v-toolbar>
        <v-card-text class="px-5 py-2">
          <!-- 表单 -->
          <brand-form :oldBrand="brand" :isEdit="isEdit" @close="show = false" :reload="getDataFromApi"/>
        </v-card-text>
      </v-card>
    </v-dialog>
  </v-card>

</template>

<script>
  import BrandForm from './BrandForm'
  import {brandData} from '../../mockDB'

  export default {
    name: "brand",
    components: {
      BrandForm
    },
    data() {
      return {
        search: '',// 过滤字段
        totalItems: 0,// 总条数
        items: [],// 表格数据
        loading: true,
        pagination: {},// 分页信息
        headers: [// 表头
          {text: 'id', align: 'center', value: 'id'},
          {text: '名称', align: 'center', sortable: false, value: 'name'},
          {text: 'LOGO', align: 'center', sortable: false, value: 'image'},
          {text: '首字母', align: 'center', value: 'letter', sortable: true,},
          {text: '操作', align: 'center', value: 'id', sortable: false}
        ],
        show: false,// 是否弹出窗口
        brand: {}, // 品牌信息
        isEdit: false // 判断是编辑还是新增
      }
    },
    watch: {
      pagination: {
        handler() {
          this.getDataFromApi();
        },
        deep: true
      },
      search: {
        handler() {
          this.getDataFromApi();
        }
      },
      show(val, oldVal) {
        // 表单关闭后重新加载数据
        if (oldVal) {
          this.getDataFromApi();
        }
      }
    },
    mounted() {
      this.getDataFromApi();
    },
    methods: {
      addBrand() {
        this.brand = {};
        this.isEdit = false;
        this.show = true;
      },
      editBrand(item) {
        this.brand = item;
        this.isEdit = true;
        this.show = true;
        // 查询商品分类信息，进行回显
        this.$http.get("/item/category/bid/" + item.id)
          .then(resp => {
            this.brand.categories = resp.data;
          })

      },
      deleteBrand(item) {
        this.$message.confirm('此操作将永久删除该品牌, 是否继续?').then(() => {
          // 发起删除请求
          this.$http.delete("/item/brand?id=" + item.id,)
            .then(() => {
              // 删除成功，重新加载数据
              this.$message.success("删除成功！");
              this.getDataFromApi();
            })
        }).catch(() => {
          this.$message.info("删除已取消！");
        });

      },
      getDataFromApi() {
        this.loading = true;
        
        window.setTimeout(() => {  // 延时器  200ms后返回假数据
          this.items = brandData.slice(0,4);
          this.totalItems = 100
          this.loading = false;
        }, 200)
      }
    }
  }
</script>
<style scoped>
</style>

```



##### 2.1.3 index.js line : 27

```js
 route("/item/brand",'/item/MrBrand',"MrBrand"),
```

### 2 common-core 

##### 2.1 pom.xml

```xml
 <!--帮助开发人员快速生成API文档-->
    <dependency>
        <groupId>io.springfox</groupId>
        <artifactId>springfox-swagger2</artifactId>
        <version>2.9.2</version>
    </dependency>
```

##### 2.2 在base包下新建BaseDTO

```
package com.baidu.shop.base;

import io.swagger.annotations.ApiModel;
import io.swagger.annotations.ApiModelProperty;
import lombok.Data;
import org.apache.commons.lang.StringUtils;
/**
 * @ClassName CategoryBrandMapper
 * @Description: TODO
 * @Author wyj
 * @Date 2020/12/28
 * @Version V1.0
 **/
@Data
@ApiModel(value = "BaseDTO用于数据传输,其他dto需要继承此类")
public class BaseDTO {

    @ApiModelProperty(value = "当前页",example = "1")
    private Integer page;

    @ApiModelProperty(value = "每页条数",example = "5")
    private Integer rows;

    @ApiModelProperty(value = "排序字段")
    private String sort;

    @ApiModelProperty(value = "是否升序")
    private String order;

    public String getOrderBy(){
        return sort + " " + (Boolean.valueOf(order)?"desc":"asc");
    }

}
```

#### 2.3 mingrui-shop-api 

##### 2.3.1 pom.xml

```xml
  <!--分页工具-->
    <dependency>
        <groupId>com.github.pagehelper</groupId>
        <artifactId>pagehelper-spring-boot-starter</artifactId>
        <version>1.2.10</version>
    </dependency>
```

#### 2.4 mingrui-shop-api-xxx 

##### 2.4.1 在com.baidu.shop下新建dto包 

##### 2.4.1.1 BrandDTO

```java
package com.baidu.shop.dto;

import com.baidu.shop.base.BaseDTO;
import com.baidu.shop.validate.group.MingruiOperation;
import io.swagger.annotations.ApiModel;
import io.swagger.annotations.ApiModelProperty;
import lombok.Data;

import javax.persistence.Id;
import javax.validation.constraints.NotEmpty;
import javax.validation.constraints.NotNull;
/**
 * @ClassName CategoryBrandMapper
 * @Description: TODO
 * @Author wyj
 * @Date 2020/12/28
 * @Version V1.0
 **/
@ApiModel(value = "品牌DTO")
@Data
public class BrandDTO extends BaseDTO {

    @Id
    @ApiModelProperty(value = "品牌主键",example = "1")
    @NotNull(message = "主键不能为空",groups = {MingruiOperation.Update.class})
    private Integer id;

    @ApiModelProperty(value = "品牌名称")
    @NotEmpty(message = "品牌名称不能为空",groups = {MingruiOperation.Update.class,MingruiOperation.Add.class})
    private String name;

    @ApiModelProperty(value = "品牌logo")
    private String image;

    @ApiModelProperty(value = "品牌首字母")
    private Character letter;

}

```

#### 2.4.2 entity包下新建BrandEntity

```java
package com.baidu.shop.entity;

import lombok.Data;

import javax.persistence.GeneratedValue;
import javax.persistence.GenerationType;
import javax.persistence.Id;
import javax.persistence.Table;
/**
 * @ClassName CategoryBrandMapper
 * @Description: TODO
 * @Author wyj
 * @Date 2020/12/28
 * @Version V1.0
 **/
@Data
@Table(name = "tb_brand")
public class BrandEntity {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)//主键自增
    private Integer id;

    private String name;

    private String image;

    private Character letter;
}

```

#### 2.4.3 service包下新建BrandService

```java
package com.baidu.shop.service;

import com.baidu.shop.base.Result;
import com.baidu.shop.dto.BrandDTO;
import com.baidu.shop.entity.BrandEntity;
import com.baidu.shop.validate.group.MingruiOperation;
import com.github.pagehelper.PageInfo;
import com.google.gson.JsonObject;
import io.swagger.annotations.Api;
import io.swagger.annotations.ApiOperation;
import org.springframework.validation.annotation.Validated;
import org.springframework.web.bind.annotation.*;
/**
 * 2 * @ClassName BrandService
 * 3 * @Description: TODO
 * 4 * @Author wyj
 * 5 * @Date 2020/12/25
 * 6 * @Version V1.0
 * 7
 **/
@Api(tags = "品牌接口")//表示标识这个类是swagger的资源
public interface BrandService {
    @ApiOperation(value = "获得品牌信息")
    @GetMapping(value = "/brand/list")
    public Result<PageInfo<BrandEntity>> getBrandInfo(BrandDTO brandDTO);

    //接口的默认修饰符为private
    @ApiOperation(value = "新增品牌")
    @PostMapping(value = "/brand/save")
    Result<JsonObject> save(@Validated({MingruiOperation.Add.class}) @RequestBody BrandDTO brandDTO);

    @ApiOperation(value = "修改品牌信息")
    @PutMapping(value = "/brand/save")
    Result<JsonObject> editBrand(@Validated({MingruiOperation.Update.class}) @RequestBody BrandDTO brandDTO);


    @ApiOperation(value = "删除品牌信息")
    @DeleteMapping(value = "/brand/deleteBrand")
    Result<JsonObject> deleteBrandId(Integer id);
}

```



#### 2.5 mingrui-shop-service-xxx 

##### 2.5.1 在mapper包下新建BrandMapper

```java
import com.baidu.shop.entity.BrandEntity;
import tk.mybatis.mapper.common.Mapper;
public interface BrandMapper extends Mapper<BrandEntity> {
}

```

##### 2.5.2 在impl包下新建BrandServiceImpl

```java
import com.baidu.shop.base.BaseApiService;
import com.baidu.shop.base.Result;
import com.baidu.shop.dto.BrandDTO;
import com.baidu.shop.entity.BrandEntity;
import com.baidu.shop.mapper.BrandMapper;
import com.baidu.shop.service.BrandService;
import com.github.pagehelper.PageHelper;
import com.github.pagehelper.PageInfo;
import org.springframework.util.StringUtils;
import org.springframework.web.bind.annotation.RestController;
import tk.mybatis.mapper.entity.Example;
import javax.annotation.Resource;
import java.util.List;
/**
 * 2 * @ClassName BrandServiceImpl
 * 3 * @Description: TODO
 * 4 * @Author wyj
 * 5 * @Date 2020/12/25
 * 6 * @Version V1.0
 * 7
 **/
@RestController
public class BrandServiceImpl extends BaseApiService implements BrandService {

    @Autowired
    private BrandMapper brandMapper;
    
    @Override
    public Result<PageInfo<BrandEntity>> getBrandInfo(BrandDTO brandDTO) {
        //分页
        PageHelper.startPage(brandDTO.getPage(),brandDTO.getRows());

        BrandEntity brandEntity = BaiduBeanUtil.copyProperties(brandDTO, BrandEntity.class);

        Example example=new Example(BrandEntity.class);

        if(!StringUtils.isEmpty(brandDTO.getSort())) PageHelper.orderBy(brandDTO.getOrderBy());

        example.createCriteria().andLike("name","%"+brandEntity.getName()+"%");

        //查询
        List<BrandEntity> list = brandMapper.selectByExample(example);

        PageInfo<BrandEntity> pageInfo = new PageInfo<>(list);

        return this.setResultSuccess(pageInfo);
    }
}
```



### 3. 品牌管理（新增）

- 模态框地址:https://v15.vuetifyjs.com/zh-Hans/components/dialogs
- form表单地址:https://v15.vuetifyjs.com/zh-Hans/components/forms

#### 3.1 vue项目 

##### 3.1.1 新建MrBrandForm.vue

```vue
<template>
  <v-form v-model="valid" ref="brandForm">
    <v-text-field
      label="品牌名称"
      v-model="brand.name"
      :rules="[v => !!v || '品牌名称不能为空']"
      :counter="10"
      required
    />
    <v-text-field
      label="首字母"
      v-model="brand.letter"
      :rules="[v => v.length === 1 || '首字母只能是1位']"
      required
      mask="A"
    />
    <v-cascader url="/item/category/list" required
                v-model="brand.categories"
                multiple label="商品分类"/>
    <v-layout row>
      <v-flex xs3>
        <span style="font-size: 16px; color: #444">品牌LOGO：</span>
      </v-flex>
      <v-flex>
        <v-upload
          v-model="brand.image" url="/item/upload" :multiple="false" :pic-width="250" :pic-height="90"
        />
      </v-flex>
    </v-layout>
    <v-layout class="my-4">
      <v-btn @click="submit" color="primary">提交</v-btn>
      <v-btn @click="clear" color="warning">重置</v-btn>
    </v-layout>
  </v-form>
</template>

<script>
  import config from '@/config';
  export default {
    name: "brand-form",
    props: {
      oldBrand: Object,
      isEdit: {
        type: Boolean,
        default: false
      },
      show: {
        type: Boolean,
        default: true
      }
    },
    data() {
      return {
        baseUrl: config.api,
        valid:false,
        brand: {
          name: "",
          image: "",
          letter: "",
          categories: []
        },
        imageDialogVisible:false
      }
    },
    watch: {
      oldBrand:{
        deep:true,
        handler(val){
          Object.deepCopy(val,this.brand);
        }
      }
    },
    methods: {
      submit() {
        // 表单校验
        if (this.$refs.brandForm.validate()) {
          this.brand.categories = this.brand.categories.map(c => c.id);
          this.brand.letter = this.brand.letter.toUpperCase();
          // 将数据提交到后台
          this.$http({
            method: this.isEdit ? 'put' : 'post',
            url: '/item/brand',
            data: this.$qs.stringify(this.brand)
          }).then(() => {
            // 关闭窗口
            this.$message.success("保存成功！");
            this.closeWindow();
          }).catch(() => {
            this.$message.error("保存失败！");
          });
        }
      },
      clear() {
        // 重置表单
        this.$refs.brandForm.reset();
        this.categories = [];
      },
      // 图片上传出成功后操作
      handleImageSuccess(res) {
        this.brand.image = res;
      },
      removeImage(){
        this.brand.image = "";
      },
      closeWindow(){
        this.$emit("close");
      }
    }
  }
</script>

<style scoped>

</style>

```

##### 3.1.2 Casecader.vue  line: 113 

```vue
	then(resp => {
            const data = [];
            for (let d of resp.data.data) {
              const node = {
                value: d[this.itemValue],
                label: d[this.itemText]
              }
              if (d.isParent) {
                node['children'] = [];
                node['loading'] = false;
              }
              data.push(node)
            }
            resolve(data);
          })
```

#### 3.2 common-core 

##### 3.2.1 在utils包下新建BaiduBeanUtil

```java
package com.baidu.shop.utils;

import org.springframework.beans.BeanUtils;
/**
 * 2 * @ClassName BaiduBeanUtil
 * 3 * @Description: TODO
 * 4 * @Author wyj
 * 5 * @Date 2020/12/25
 * 6 * @Version V1.0
 * 7
 **/
public class BaiduBeanUtil {
    public static <T> T copyProperties(Object source,Class<T> clazz){

        try {
            T t = clazz.newInstance();//创建当前类型的实例
            BeanUtils.copyProperties(source,t);
            return t;
        } catch (InstantiationException e) {
            e.printStackTrace();
        } catch (IllegalAccessException e) {
            e.printStackTrace();
        }

        return null;
    }
}

```



#### 3.3 mingrui-shop-service-api-xxx 

##### 3.3.1  BrandDTO

```java
	@ApiModelProperty(value = "品牌id集合")
    @NotEmpty(message = "品牌分类信息不能为空",groups = {MingruiOperation.Add.class})
    private String categories;
```

##### 3.3.2 entity包下新建CategoryBrandEntity

```java
package com.baidu.shop.entity;

import io.swagger.annotations.ApiModel;
import lombok.AllArgsConstructor;
import lombok.Data;
import lombok.NoArgsConstructor;
import javax.persistence.Table;
/**
 * 2 * @ClassName CategoryBrandEntity
 * 3 * @Description: TODO
 * 4 * @Author wyj
 * 5 * @Date 2020/12/28
 * 6 * @Version V1.0
 * 7
 **/
@Data
@Table(name = "tb_category_brand")
@NoArgsConstructor
@AllArgsConstructor
public class CategoryBrandEntity {
    private Integer categoryId;

    private Integer brandId;
}

```

##### 3.4.3  BrandServiceImpl

```java
	@Autowired
    private CategoryBrandMapper categoryBrandMapper;

//通过brandId删除中间表的数据
private void deleteCategoryBrandList(Integer id){
    Example example = new Example(CategoryBrandEntity.class);
    example.createCriteria().andEqualTo("brandId",id);
    categoryBrandMapper.deleteByExample(example);
}

private void insertBrandId(String categories,Integer brandId){

    if (StringUtils.isEmpty(categories)) throw new RuntimeException();
    if (categories.contains(",")){
        categoryBrandMapper.insertList(
                Arrays.asList(categories.split(","))
                        .stream()
                        .map(categoryIds->new CategoryBrandEntity(Integer.valueOf(categoryIds),brandId))
                        .collect(Collectors.toList())
        );
    }else{
        CategoryBrandEntity categoryBrandEntity = new CategoryBrandEntity();
        categoryBrandEntity.setCategoryId(Integer.valueOf(categories));
        categoryBrandEntity.setBrandId(brandId);
        categoryBrandMapper.insertSelective(categoryBrandEntity);
    }
}
```

##### 新增impl

```java
 @Override
    public Result<JsonObject> save(BrandDTO brandDTO) {
        //新增返回主键
        //两种方式实现 select-key insert加两个属性

        BrandEntity brandEntity = BaiduBeanUtil.copyProperties(brandDTO, BrandEntity.class);//处理品牌首字母
        brandEntity.setLetter(PinyinUtil.getUpperCase(String.valueOf(brandEntity.getName().toCharArray()[0]),false).toCharArray()[0]);
        brandMapper.insertSelective(brandEntity);
        
        this.insertBrandId(brandDTO.getCategories(),brandEntity.getId());

        return this.setResultSuccess();
    }
```

##### 4.1.3.1mingrui-shop-service-xxx下创建 CategoryMapper

```java
import com.baidu.shop.entity.CategoryEntity;

import org.apache.ibatis.annotations.Select;
import tk.mybatis.mapper.common.Mapper;

import java.util.List;


public interface CategoryMapper extends Mapper<CategoryEntity> {

    @Select(value = "SELECT id,name from tb_category where id in (select category_id from tb_category_brand where brand_id=#{brandId})")
    List<CategoryEntity> getCategoryByBrandId(Integer brandId);
}
```

##### 修改impl

```java
@Transactional
@Override
public Result<JsonObject> editBrand(BrandDTO brandDTO) {
    BrandEntity brandEntity = BaiduBeanUtil.copyProperties(brandDTO, BrandEntity.class);
    brandEntity.setLetter(PinyinUtil.getUpperCase(String.valueOf(brandEntity.getName().toCharArray()[0]),false).toCharArray()[0]);
    brandMapper.updateByPrimaryKeySelective(brandEntity);

    //先通过brandId删除中间表的数据
    //封装的方法
    this.deleteCategoryBrandList(brandEntity.getId());

    //批量新增  得到分类集合字符串
    //String categories = brandDTO.getCategories();
    
    this.insertBrandId(brandDTO.getCategories(),brandEntity.getId());

    return this.setResultSuccess();
}
```

##### 删除impl

```java
@Override
public Result<JsonObject> deleteBrandId(Integer id) {
    brandMapper.deleteByPrimaryKey(id);
    //封装方法-----通过brandId删除中间表的数据
    this.deleteCategoryBrandList(id);
    return this.setResultSuccess();
}
```



### 4.品牌首字母自动识别

#### 4.1 common-core 

##### 4.1.2.1 pom.xml

```xml
    <dependency>
        <groupId>com.belerweb</groupId>
        <artifactId>pinyin4j</artifactId>
        <version>2.5.1</version>
    </dependency>

```

##### 4.1.2.2 在utils包下新建PinyinUtil

```
package com.baidu.shop.utils;

import net.sourceforge.pinyin4j.PinyinHelper;
import net.sourceforge.pinyin4j.format.HanyuPinyinOutputFormat;
import net.sourceforge.pinyin4j.format.HanyuPinyinToneType;

import java.util.regex.Matcher;
import java.util.regex.Pattern;

/**
 * 2 * @ClassName PinyinUtil
 * 3 * @Description: TODO
 * 4 * @Author wyj
 * 5 * @Date 2020/12/28
 * 6 * @Version V1.0
 * 7
 **/
public class PinyinUtil {
    public static final Boolean TO_FUUL_PINYIN = true;
    public static final Boolean TO_FIRST_CHAR_PINYIN = false;
    /**
     * 获取汉字首字母或全拼大写字母
     *
     * @param chinese 汉字
     * @param isFull 是否全拼 true:表示全拼 false表示：首字母
     * @return 全拼或者首字母大写字符窜
     */
    public static String getUpperCase(String chinese, boolean isFull) {
        return convertHanzi2Pinyin(chinese, isFull).toUpperCase();
    }
    /**
     * 获取汉字首字母或全拼小写字母
     *
     * @param chinese 汉字
     * @param isFull 是否全拼 true:表示全拼 false表示：首字母
     * @return 全拼或者首字母小写字符窜
     */
    public static String getLowerCase(String chinese, boolean isFull) {
        return convertHanzi2Pinyin(chinese, isFull).toLowerCase();
    }
    /**
     * 将汉字转成拼音
     * <p>
     * 取首字母或全拼
     *
     * @param hanzi 汉字字符串
     * @param isFull 是否全拼 true:表示全拼 false表示：首字母
     * @return 拼音
     */
    private static String convertHanzi2Pinyin(String hanzi, boolean isFull) {
        /***
         * ^[\u2E80-\u9FFF]+$ 匹配所有东亚区的语言
         * ^[\u4E00-\u9FFF]+$ 匹配简体和繁体
         * ^[\u4E00-\u9FA5]+$ 匹配简体
         */
        String regExp = "^[\u4E00-\u9FFF]+$";
        StringBuffer sb = new StringBuffer();
        if (hanzi == null || "".equals(hanzi.trim())) {
            return "";
        }
        String pinyin = "";
        for (int i = 0; i < hanzi.length(); i++) {
            char unit = hanzi.charAt(i);
//是汉字，则转拼音
            if (match(String.valueOf(unit), regExp)) {
                pinyin = convertSingleHanzi2Pinyin(unit);
                if (isFull) {
                    sb.append(pinyin);
                } else {
                    sb.append(pinyin.charAt(0));
                }
            } else {
                sb.append(unit);
            }
        }
        return sb.toString();
    }
    /**
     * 将单个汉字转成拼音
     *
     * @param hanzi 汉字字符
     * @return 拼音
     */
    private static String convertSingleHanzi2Pinyin(char hanzi) {
        HanyuPinyinOutputFormat outputFormat = new HanyuPinyinOutputFormat();
        outputFormat.setToneType(HanyuPinyinToneType.WITHOUT_TONE);
        String[] res;
        StringBuffer sb = new StringBuffer();
        try {
            res = PinyinHelper.toHanyuPinyinStringArray(hanzi, outputFormat);
            sb.append(res[0]);//对于多音字，只用第一个拼音
        } catch (Exception e) {
            e.printStackTrace();
            return "";
        }
        return sb.toString();
    }
/**
 * 匹配
 * <P>
 * 根据字符和正则表达式进行匹配
 *
 * @param str 源字符串
 *  @param regex 正则表达式
 *
 *  @return true：匹配成功 false：匹配失败
 * */
    private static boolean match(String str, String regex) {
        Pattern pattern = Pattern.compile(regex);
        Matcher matcher = pattern.matcher(str);
        return matcher.find();
    }

}
```



### 5.图片上传

#### 1.vue项目

#### 2.Upload.vue line:88&89

```vue
		this.dialogImageUrl = file.response.data;
        this.$emit("input", file.response.data)
```

##### 3. MrBrandForm.vue,   在1.2中的vue中

##### 4. 在mingrui-shop-basics下新建mingrui-shop-basic-uploadserver

##### 	4.1. pom.xml

```XML
<dependencies>
    <!-- SpringBoot-整合Web组件 -->
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-web</artifactId>
    </dependency>
    <dependency>
        <groupId>com.baidu</groupId>
        <artifactId>mingrui-shopcommon-core</artifactId>
        <version>1.0-SNAPSHOT</version>
    </dependency>
</dependencies>
```

##### 4.2. application.yml

```yml
server:
  port: 8200
spring:
  application:
    name: upload-server
eureka:
  client:
    service-url:
      defaultZone: http://localhost:8761/eureka

mingrui:
  upload:
    path:
      windows: D:\\images
      linux: /wang/images
    img:
      host: http://image.mrshop.com
```

##### 4.3  启动类

```java
package com.baidu;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.cloud.netflix.eureka.EnableEurekaClient;

/**
 * 2 * @ClassName RunUploadServerApplication
 * 3 * @Description: TODO
 * 4 * @Author wyj
 * 5 * @Date 2020/12/29
 * 6 * @Version V1.0
 * 7
 **/
@SpringBootApplication
@EnableEurekaClient
public class RunUploadServerApplication {
    public static void main(String[] args) {
        SpringApplication.run(RunUploadServerApplication.class);
    }
}
```

##### 4.4 . 新建包com.baidu.shop.upload.controller，

##### 4.5 . 在包下新建UploadController

```java
package com.baidu.shop.upload.controller;

import com.baidu.shop.base.BaseApiService;
import com.baidu.shop.base.Result;
import com.baidu.shop.status.HTTPStatus;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.web.bind.annotation.*;
import org.springframework.web.multipart.MultipartFile;

import java.io.File;
import java.io.IOException;
import java.util.UUID;

/**
 * 2 * @ClassName UploadController
 * 3 * @Description: TODO
 * 4 * @Author wyj
 * 5 * @Date 2020/12/29
 * 6 * @Version V1.04
 * 7
 **/
@RestController
@RequestMapping(value = "upload")
public class UploadController extends BaseApiService {
    //linux系统的上传目录
    @Value(value = "${mingrui.upload.path.windows}")
    private String windowsPath;
    //window系统的上传目录
    @Value(value = "${mingrui.upload.path.linux}")
    private String linuxPath;
    //图片服务器的地址
    @Value(value = "${mingrui.upload.img.host}")
    private String imageHost;
    @PostMapping
    public Result<String> uploadImg(@RequestParam MultipartFile file) {
        if(file.isEmpty()) return this.setResultError("上传的文件为空");//判断上传的
        //文件是否为空
        String filename = file.getOriginalFilename();//获取文件名
        String path = "";
        String os = System.getProperty("os.name").toLowerCase();
        if(os.indexOf("win") != -1){
            path = windowsPath;
        }else if(os.indexOf("lin") != -1){
            path = linuxPath;
        }
        filename = UUID.randomUUID() + filename;//防止文件名重复
        //创建文件 路径+分隔符(linux和window的目录分隔符不一样)+文件名
        File dest = new File(path + File.separator + filename);
        //判断文件夹是否存在,不存在的话就创建
        if(!dest.getParentFile().exists()) dest.getParentFile().mkdirs();
        try {
            file.transferTo(dest);//上传
        } catch (IllegalStateException e) {
        // TODO Auto-generated catch block
            e.printStackTrace();
        } catch (IOException e) {
        // TODO Auto-generated catch block
            e.printStackTrace();
        }
        return this.setResult(HTTPStatus.OK,"upload success!!!",imageHost + "/"+ filename);//将文件名返回页面用于页面回显
    }

}
```

##### 4.6 新建包:com.baidu.global

##### 4.7 GlobalCorsConfig

```java
package com.baidu.global;

import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.web.cors.CorsConfiguration;
import org.springframework.web.cors.UrlBasedCorsConfigurationSource;
import org.springframework.web.filter.CorsFilter;

/**
 * 2 * @ClassName GlobalCorsConfig
 * 3 * @Description: TODO
 * 4 * @Author wyj
 * 5 * @Date 2020/12/29
 * 6 * @Version V1.0
 * 7
 **/
@Configuration
public class GlobalCorsConfig {
    @Bean
    public CorsFilter corsFilter() {
        final UrlBasedCorsConfigurationSource source = new UrlBasedCorsConfigurationSource();
        final CorsConfiguration config = new CorsConfiguration();
        config.setAllowCredentials(true); // 允许cookies跨域
        config.addAllowedOrigin("*");// 允许向该服务器提交请求的URI，*表示全部允许。。这里尽量限制来源域，比如http://xxxx:8080 ,以降低安全风险。。
        config.addAllowedHeader("*");// 允许访问的头信息,*表示全部
        config.setMaxAge(18000L);// 预检请求的缓存时间（秒），即在这个时间段里，对于相同的跨域请求不会再预检了
        config.addAllowedMethod("*");// 允许提交请求的方法，*表示全部允许，也可以单独设置GET、PUT等
        config.addAllowedMethod("HEAD");
        config.addAllowedMethod("GET");// 允许Get的请求方法
        config.addAllowedMethod("PUT");
        config.addAllowedMethod("POST");
        config.addAllowedMethod("DELETE");
        config.addAllowedMethod("PATCH");
        source.registerCorsConfiguration("/**", config);
        //3.返回新的CorsFilter.
        return new CorsFilter(source);
    }

}
```

##### 4.8 使用postman测试上传

##### 4.9 我们将利用nginx来做代理服务,代理本地目录

##### 4.10 hosts文件中新增

```
127.0.0.1 image.mrshop.com
```

##### 4.11 nginx-home/conf/nginx.conf新增

```
	server {
        listen 	80;
        server_name image.mrshop.com;
        
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Server $host;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        
        location ~ .*\.(gif|jpg|pdf|jpeg|png)$
        {
        	#root D:/nginx-1.15.5/temp/images/;#指定图片存放路径(可以放在nginx文件夹路
       	 	径里也可以放其他p盘)
        	root E:\images;
        }
        
        location / {
    		root html;
    		index index.html index.htm;
    	}
    }

```

##### 4.12 重启nginx   

```
nginx.exe -s reload
```

##### 4.13  浏览器输入http://image.mrshop.com/imageName.jpg测试

##### 4.14  zuul的application.yml

```yml
zuul:
  # 声明路由
  routes:
    # 路由名称
    api-xxx:
      # 声明将所有以/api-ribbon/的请求都转发到eureka-ribbon的服务中
      path: /api-xxx/**
      serviceId: xxx-server
  # 启用重试
  retryable: true
  # 包含此路径的不进行路由
  ignored-patterns: /upload/**
  # 忽略上传服务
  ignored-services:
    -upload-server

```

在nginx-home/conf/nginx.conf 添加api.mrshop.com的代理配置

```
    # 上传路径的映射
    # 只要包含/api-xxx/upload 都会把请求映射到8200服务
    # rewrite "^/api-xxx/(.*)$" /$1 break;
    # 将/api-xxx 替换成/
    location /api-xxx/upload {
        proxy_pass http://127.0.0.1:8200;
        proxy_connect_timeout 600;
        proxy_read_timeout 600;
        
        rewrite "^/api-xxx/(.*)$" /$1 break;
    }
```





## 三 - 规格组管理

## 1.查询

#### 1.1  前台 index.js   line:29  修改我们自己的url   **specification/** Specification.vue

![image-20210105142051092](C:\Users\wyj\AppData\Roaming\Typora\typora-user-images\image-20210105142051092.png)

```js
route("/item/specification",'/item/specification/Specification',"Specification"),
```



#### 1.2  SpecGroup.vue line: 73

![image-20210105142714282](C:\Users\wyj\AppData\Roaming\Typora\typora-user-images\image-20210105142714282.png)

```vue
   loadData(){
          this.$http.get("specgroup/getSpecGroupInfo?cid=" + this.cid)
          .then(({data}) => {
              this.groups = data.data; // 这样写 需要 .data
          })
          .catch(() => {
              this.groups = [];
          })
      },
```



#### 1.3 后台**mingrui-shop-service-api-xxx**  

###### 在mingrui-shop-service-api-xxx  entity包下新建 SpecGroupEntity

![image-20210105143140265](C:\Users\wyj\AppData\Roaming\Typora\typora-user-images\image-20210105143140265.png)

#### 1.3.1 在dao包下新建 SpecGroupDTO

![image-20210105143330390](C:\Users\wyj\AppData\Roaming\Typora\typora-user-images\image-20210105143330390.png)

#### 1.3.2 service包下新建SpecificationService  注意 ： 是接口

![image-20210105143536781](C:\Users\wyj\AppData\Roaming\Typora\typora-user-images\image-20210105143536781.png)

#### 1.4 mingrui-shop-service-xxx mapper包下新建SpecGroupMapper  

![image-20210105143828215](C:\Users\wyj\AppData\Roaming\Typora\typora-user-images\image-20210105143828215.png)



#### 1.5在service.impl 下 新建 SpecificationServiceImpl

![image-20210105144038589](C:\Users\wyj\AppData\Roaming\Typora\typora-user-images\image-20210105144038589.png)



## 2.规格组（新增，删除，修改）

#### 2.1 前台 Vue 项目 

#### 2.1.1 SpecGroup.vue 

```vue
   save(){
           this.$http({
            method: this.isEdit ? 'put' : 'post',
            url: 'specgroup/save',
            data: this.group
          }).then(() => {
            // 关闭窗口
            this.show = false;
            this.$message.success("保存成功！");
            this.loadData();
          }).catch(() => {
              this.$message.error("保存失败！");
            });
      },
      deleteGroup(id){
          console.log(id);
          this.$message.confirm("确认要删除分组吗？")
          .then(() => {
            this.$http.delete("specgroup/delete?id=" + id)
                .then((resp) => {
                    if(resp.data.code != 200){
                        this.$message.error("该规格组下有绑定规格参数，不能删除,需要先删除规格参数");
                        return;
                    }
                    this.$message.success("删除成功");
                    this.loadData();
                })
          })
      },
```

[^注意：]: SpecGroup.vue line:111  加if判断是为了 判断规格组下是否有规格参数   true：不能被删除  false： 能被删除

```vue
                if(resp.data.code != 200){
                    this.$message.error("该规格组下有绑定规格参数，不能删除,需要先删除规格参数");
                    return;
                }
```
#### 2.2 mingrui-shop-service-api-xxx 下的 SpecificationService

```java
   //新增  specgroup/save
      @ApiOperation(value = "新增规格组")
      @PostMapping(value = "specgroup/save")
      Result<JSONObject> save(@RequestBody SpecGroupDTO specGroupDTO);


    @ApiOperation(value = "修改规格组")
    @PutMapping(value = "specgroup/save")
    Result<JSONObject> editSpecGroup(@RequestBody SpecGroupDTO specGroupDTO);

    //specgroup/deleteSpecGroupInfo  删除
    @ApiOperation(value = "删除规格组")
    @DeleteMapping(value = "specgroup/delete")
    Result<JSONObject> deleteSpecGroupInfo(Integer id);
```

#### 2.3 mingrui-shop-service-xxx  下的SpecificationServiceImpl

```java
  @Transactional
    @Override
    public Result<JSONObject> save(SpecGroupDTO specGroupDTO) {
        specGroupMapper.insertSelective(BaiduBeanUtil.copyProperties(specGroupDTO,SpecGroupEntity.class));
        return this.setResultSuccess();
    }

    @Transactional
    @Override
    public Result<JSONObject> editSpecGroup(SpecGroupDTO specGroupDTO) {
        specGroupMapper.updateByPrimaryKeySelective(BaiduBeanUtil.copyProperties(specGroupDTO,SpecGroupEntity.class));
        return this.setResultSuccess();
    }

    @Transactional
    @Override
    public Result<JSONObject> deleteSpecGroupInfo(Integer id) {

        Example example = new Example(SpecParamEntity.class);
        example.createCriteria().andEqualTo("groupId",id);
        List<SpecParamEntity> specParamEntities = specParamMapper.selectByExample(example);
        if(specParamEntities.size() != 0) return this.setResultError("绑定有规格组， 不能被删除");

        specGroupMapper.deleteByPrimaryKey(id);
        return  this.setResultSuccess();
    }

```



### 3.规格参数的查询

#### 3.1 Vue 项目 

#### 3.1.1 SpecParam.vue line :125

```vue
 loadData() {
      this.$http
        .get("specparam/list",{
          params:{
            groupId:this.group.id
          }
        })
        .then((resp) => {
          resp.data.data.forEach(p => {
              p.segments = p.segments ? p.segments.split(",").map(s => s.split("-")) : [];
          })
          this.params = resp.data.data;
        })
        .catch(() => {
          this.params = [];
        });
    },
```

#### 3.2 mingrui-shop-service-api-xxx  下的entity 包新建 SpecParamEntity

  	注意： numeric 是关键字 需要处理  加注解@Column(name = "`numeric`")

​	numeric ，generic 和searching  需要由Integer类型换成 Boolean类型   mysql 里的 0 代表true 1 false

```java
@Table(name = "tb_spec_param")
@Data
public class SpecParamEntity {

    @Id
    private Integer id;

    private Integer cid;

    private Integer groupId;

    private String name;

    @Column(name = "`numeric`")
    private Boolean numeric;

    private String unit;

    private Boolean generic;

    private Boolean searching;

    private String segments;

}
```



#### 3.2.1dto包下新建SpecParamDTO

### 注意： numeric  generic  searching是Boolean 类型

```java
@ApiModel(value = "规格参数数据传输DTO")
@Data
public class SpecParamDTO extends BaseDTO {

    @ApiModelProperty(value = "主键",example = "1")
    @NotNull(message="主键不能为空", groups={MingruiOperation.Update.class})
    private Integer id;

    @ApiModelProperty(value = "分类id", example = "1")
    private Integer cid;

    @ApiModelProperty(value = "规格组id", example = "1")
    private Integer groupId;

    @ApiModelProperty(value = "规格参数名称")
    private String name;

    @ApiModelProperty(value = "是否是数字类型参数，1->true或0->false", example = "0")
    @NotNull(message = "是否是数字类型参数不能为空",groups = {MingruiOperation.Add.class,MingruiOperation.Update.class})
    private Boolean numeric;

    @ApiModelProperty(value = "数字类型参数的单位，非数字类型可以为空")
    private String unit;

    @ApiModelProperty(value = "是否是sku通用属性，1->true或0->false", example = "0")
    @NotNull(message = "是否是sku通用属性不能为空",groups = {MingruiOperation.Add.class,MingruiOperation.Update.class})
    private Boolean generic;

    @ApiModelProperty(value = "是否用于搜索过滤，1->true或0->false", example = "0")
    @NotNull(message = "是否用于搜索过滤不能为空",groups = {MingruiOperation.Add.class,MingruiOperation.Update.class})
    private Boolean searching;

    @ApiModelProperty(value = "数值类型参数，如果需要搜索，则添加分段间隔值，如CPU频率间隔：0.5-1.0")
    private String segments;
}

```

### 3.2.3 SpecificationService 

```java
	// specparam/list?
    @ApiOperation(value = "查询规格参数")
    @GetMapping(value = "specparam/list")
    Result<List<SpecParamEntity>> getSepcGroupInfo(SpecParamDTO specParamDTO);
```



### 3.3.1 mingrui-shop-service-xxx  mapper包下新建 SpecParamMapper

```java
public interface SpecParamMapper extends Mapper<SpecParamEntity> {
}

```

### 3.3.2 SpecificationServiceImpl    

```java
 	@Autowired
    private SpecParamMapper specParamMapper;
    
      @Override
    public Result<List<SpecParamEntity>> getSepcGroupInfo(SpecParamDTO specParamDTO) {
        SpecParamEntity specParamEntity = BaiduBeanUtil.copyProperties(specParamDTO, SpecParamEntity.class);
        Example example = new Example(SpecParamEntity.class);
        example.createCriteria().andEqualTo("groupId",specParamEntity.getGroupId());
        List<SpecParamEntity> specParamEntities = specParamMapper.selectByExample(example);
        return this.setResultSuccess(specParamEntities);
    }


```



## 3.4规格参数 的新增 删除 修改

#### 3.4.1 前台 vue 项目  SpecParam.vue

bug修复  解决修改之后不能新增的问题   是因为修改后的 isEdit 还是为true 意为还是修改 在line：156 行   加

this.isEdit = false;

```vue
methods: {
    loadData() {
      this.$http
        .get("specparam/list",{
          params:{
            groupId:this.group.id
          }
        })
        .then((resp) => {
          resp.data.data.forEach(p => {
              p.segments = p.segments ? p.segments.split(",").map(s => s.split("-")) : [];
          })
          this.params = resp.data.data;
        })
        .catch(() => {
          this.params = [];
        });
    },
    editParam(param) {
        this.param = param;
        this.isEdit = true;
        this.show = true;
    },
    addParam() {
      this.param = {
          cid: this.group.cid,
          groupId: this.group.id,
          segments:[],
          numeric:false,
          searching:false,
          generic:false}
         this.show = true;
         this.isEdit = false;

    },
    deleteParam(id) {
        this.$message.confirm("确认要删除该参数吗？")
        .then(() => {
            this.$http.delete("specparam/del?id=" + id)
            .then(() => {
                this.$message.success("删除成功");
                this.loadData();
            })
            .catch(() => {
                this.$message.error("删除失败");
            })
        })
    },
    formatBoolean(boo) {
      return boo ? "是" : "否";
    },
    save(){
        const p = {};
        Object.assign(p, this.param);
        p.segments = p.segments.map(s => s.join("-")).join(",")
        this.$http({
            method: this.isEdit ? 'put' : 'post',
            url: 'specparam/save',
            data: p,
        }).then(() => {
            // 关闭窗口
            this.show = false;
            this.$message.success("保存成功！");
            this.loadData();
          }).catch(() => {
              this.$message.error("保存失败！");
            });
    }
  }
```



### 3.4.2  mingrui-shop-service-api-xxx 

#### 3.4.2.1   SpecificationService

```java
// specparam/save
    @ApiOperation(value = "新增规格参数")
    @PostMapping(value = "specparam/save")
    Result<JSONObject> save(@RequestBody SpecParamDTO specParamDTO);

    @ApiOperation(value = "修改规格参数")
    @PutMapping(value = "specparam/save")
    Result<JSONObject> editSpecParam(@RequestBody SpecParamDTO specParamDTO);

    //specparam/del  删除
    @ApiOperation(value = "删除规格参数")
    @DeleteMapping(value = "specparam/del")
    Result<JSONObject> deleteSpecParamInfo(Integer id);
```



### 3.4.3 mingrui-shop-service-xxx

#### 3.4.3.1   SpecificationServiceImpl

```java
  @Transactional  // 添加
    @Override
    public Result<JSONObject> save(SpecParamDTO specParamDTO) {

        specParamMapper.insertSelective(BaiduBeanUtil.copyProperties(specParamDTO,SpecParamEntity.class));
        return this.setResultSuccess();
    }

    @Transactional  // 修改
    @Override
    public Result<JSONObject> editSpecParam(SpecParamDTO specParamDTO) {
          specParamMapper.updateByPrimaryKeySelective(BaiduBeanUtil.copyProperties(specParamDTO,SpecParamEntity.class));
         return this.setResultSuccess();
    }

    @Transactional  // 删除
    @Override
    public Result<JSONObject> deleteSpecParamInfo(Integer id) {
        specParamMapper.deleteByPrimaryKey(id);
        return this.setResultSuccess();
    }
```

### 四， 商品管理

### 查询

#### 1 前台 vue 

#### Goods.vue  line:8   line: 204 

```vue
8    <v-btn-toggle mandatory v-model="search.saleable">
          <v-btn flat :value="2">
            全部
          </v-btn>
          <v-btn flat :value="1">
            上架
          </v-btn>
          <v-btn flat :value="0">
            下架
          </v-btn>
        </v-btn-toggle>

204
   getDataFromApi() {
        this.loading = true;
        this.$http.get('/goods/getSpuInfo',{
          params: {
            page: this.pagination.page,
            rows: this.pagination.rowsPerPage,
            sort: this.pagination.sortBy,
            order: this.pagination.descending,
            saleable:this.search.saleable,
            title: this.search.key
          },
        }).then(resp =>{
             console.log(resp)
            //  this.items = resp.data.data.list;
              this.items = resp.data.data;
              this.totalItems = resp.data.message - 0 ;  // 也可以写成 parseInt(resp.data.message)
              this.loading = false;
            }).catch(error => console.log(error))
        }

```



#### 2 后台  **mingrui-shop-service-api-xxx**

##### 2.1 entity包下新建SpuEntity

```java
package com.baidu.shop.entity;

import lombok.Data;

import javax.persistence.GeneratedValue;
import javax.persistence.GenerationType;
import javax.persistence.Id;
import javax.persistence.Table;
import java.util.Date;

/**
 * @ClassName SpuEntity
 * @Description: TODO
 * @Author wyj
 * @Date 2021/1/5
 * @Version V1.0
 **/
@Table(name = "tb_spu")
@Data
public class SpuEntity {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY )
    private Integer id;

    private String title;

    private String subTitle;

    private Integer cid1;

    private Integer cid2;

    private Integer cid3;

    private Integer brandId;

    private Integer saleable;

    private Integer valid;

    private Date createTime;

    private Date lastUpdateTime;

}

```



#### 2.2 dto包下新建SpuDTO



```java
package com.baidu.shop.dto;

import com.baidu.shop.base.BaseDTO;
import com.baidu.shop.validate.group.MingruiOperation;
import io.swagger.annotations.ApiModel;
import io.swagger.annotations.ApiModelProperty;
import lombok.Data;

import javax.validation.constraints.NotEmpty;
import javax.validation.constraints.NotNull;
import java.util.Date;
import java.util.List;

/**
 * @ClassName SpuDTO
 * @Description: TODO
 * @Author wyj
 * @Date 2021/1/5
 * @Version V1.0
 **/
@ApiModel(value = "spu数据传输的DTO")
@Data
public class SpuDTO extends BaseDTO {

    @ApiModelProperty(value = "主键",example = "1")
    @NotNull(message = "主键不能为空", groups = {MingruiOperation.Update.class})
    private Integer id;

    @ApiModelProperty(value = "标题")
    @NotNull(message = "标题不能为空", groups = {MingruiOperation.Add.class})
    private String title;

    @ApiModelProperty(value = "子标题")
    private String subTitle;

    @ApiModelProperty(value = "1级类目id",example = "1")
    @NotNull(message = "1级类目id不能为空", groups = {MingruiOperation.Add.class})
    private Integer cid1;

    @ApiModelProperty(value = "2级类目id",example = "1")
    @NotNull(message = "2级类目id不能为空", groups = {MingruiOperation.Add.class})
    private Integer cid2;

    @ApiModelProperty(value = "3级类目id",example = "1")
    @NotNull(message = "3级类目id不能为空", groups = {MingruiOperation.Add.class})
    private Integer cid3;


    @ApiModelProperty(value = "商品所属品牌id",example = "1")
    @NotNull(message = "商品所属品牌id不能为空", groups = {MingruiOperation.Add.class})
    private Integer brandId;

    @ApiModelProperty(value = "是否上架， 0下架， 1上架",example = "1")
    private Integer saleable;

    @ApiModelProperty(value = "是否有效， 0已删除， 1有效",example = "1")
    private Integer valid;

    @ApiModelProperty(value = "添加时间")
    private Date createTime;

    @ApiModelProperty(value = "最后修改时间")
    private Date lastUpdateTime;

    private String categoryName;

    private String brandName;


}

```



#### 2.3 service包下新建GoodsService

```
package com.baidu.shop.service;

import com.alibaba.fastjson.JSONObject;
import com.baidu.shop.base.Result;
import com.baidu.shop.dto.SkuDTO;
import com.baidu.shop.dto.SpuDTO;
import com.baidu.shop.entity.SpuDetailEntity;
import com.github.pagehelper.PageInfo;
import io.swagger.annotations.Api;
import io.swagger.annotations.ApiOperation;
import org.springframework.web.bind.annotation.*;

import java.util.List;

/**
 * @ClassName GoodsService
 * @Description: TODO
 * @Author wyj
 * @Date 2021/1/5
 * @Version V1.0
 **/
@Api(tags = "商品接口")
public interface GoodsService {

    @ApiOperation(value = "获取spu信息")
    @GetMapping(value = "goods/getSpuInfo")
    Result<List<SpuDTO>> getSupInfo(SpuDTO spuDTO);

}

```



#### 2.4 mingrui-shop-service-xxx

####  mapper包下新建SpuMapper

```
package com.baidu.shop.mapper;

import com.baidu.shop.entity.SpuEntity;
import tk.mybatis.mapper.common.Mapper;

/**
 * @ClassName SpuMapper
 * @Description: TODO
 * @Author wyj
 * @Date 2021/1/5
 * @Version V1.0
 **/
public interface SpuMapper extends Mapper<SpuEntity> {
}

```

#### 修改CategoryMapper

```
package com.baidu.shop.mapper;

import com.baidu.shop.entity.CategoryEntity;
import org.apache.ibatis.annotations.Select;
import tk.mybatis.mapper.additional.idlist.SelectByIdListMapper;
import tk.mybatis.mapper.common.Mapper;

import java.util.List;

/**
 * @ClassName CategoryMapper
 * @Description: TODO
 * @Author wangyanjun
 * @Date 2020/12/22
 * @Version V1.0
 **/
public interface CategoryMapper extends Mapper<CategoryEntity>, SelectByIdListMapper<CategoryEntity,Integer> {

    //接口 + 实现类 + xml
    //接口 + xml
    //接口 + 注解(@Select + @Insert .....)
    @Select(value = "select id,name from tb_category where id in (select category_id from tb_category_brand where brand_id=#{brandId})")
    List<CategoryEntity> getCategoryByBrandId(Integer brandId);

}

```

#### service.impl包下新建GoodsServiceImpl

```
package com.baidu.shop.service.impl;

import com.alibaba.fastjson.JSONObject;
import com.baidu.shop.base.BaseApiService;
import com.baidu.shop.base.Result;
import com.baidu.shop.dto.SkuDTO;
import com.baidu.shop.dto.SpuDTO;
import com.baidu.shop.dto.SpuDetailDTO;
import com.baidu.shop.entity.*;
import com.baidu.shop.mapper.*;
import com.baidu.shop.service.GoodsService;
import com.baidu.shop.status.HTTPStatus;
import com.baidu.shop.utils.BaiduBeanUtil;
import com.baidu.shop.utils.ObjectUtil;
import com.github.pagehelper.PageHelper;
import com.github.pagehelper.PageInfo;
import com.github.pagehelper.util.StringUtil;
import lombok.extern.slf4j.Slf4j;
import org.springframework.transaction.annotation.Transactional;
import org.springframework.util.StringUtils;
import org.springframework.web.bind.annotation.RestController;
import tk.mybatis.mapper.entity.Example;

import javax.annotation.Resource;
import java.util.Arrays;
import java.util.Date;
import java.util.List;
import java.util.stream.Collectors;

/**
 * @ClassName GoodsServiceImpl
 * @Description: TODO
 * @Author wyj
 * @Date 2021/1/5
 * @Version V1.0
 **/
@RestController
@Slf4j
public class GoodsServiceImpl extends BaseApiService implements GoodsService {

    @Resource
    private SpuMapper spuMapper;

    @Resource
    private CategoryMapper categoryMapper;

    @Resource
    private BrandMapper brandMapper;

    @Resource
    private SpuDetailMapper spuDetailMapper;

    @Resource
    private SkuMapper skuMapper;

    @Resource
    private StockMapper stockMapper;

    //----------------------------------------商品信息 的查询
    @Override
    public Result<List<SpuDTO>> getSupInfo(SpuDTO spuDTO) {
        // 分页
        if(ObjectUtil.isNotNull(spuDTO.getPage()) && ObjectUtil.isNotNull(spuDTO.getRows()))
            PageHelper.startPage(spuDTO.getPage(),spuDTO.getRows());

        //排序
        if(!StringUtil.isEmpty(spuDTO.getSort()) && !StringUtil.isEmpty(spuDTO.getOrder()))
            PageHelper.orderBy(spuDTO.getOrderBy());

        Example example = new Example(SpuEntity.class);
        Example.Criteria criteria = example.createCriteria();

        // 上架和下架
        if(ObjectUtil.isNotNull(spuDTO.getSaleable()) && spuDTO.getSaleable() < 2)
            criteria.andEqualTo("saleable",spuDTO.getSaleable());

        //搜索 模糊查询
        if(!StringUtils.isEmpty(spuDTO.getTitle()))
            criteria.andLike("title", "%"+spuDTO.getTitle() +"%");

        List<SpuEntity> spuEntities = spuMapper.selectByExample(example);

        List<SpuDTO> spuDTOList  = spuEntities.stream().map(spuEntity -> {
            SpuDTO spuDTO1 = BaiduBeanUtil.copyProperties(spuEntity, SpuDTO.class);
             /* // 第一种
            CategoryEntity categoryEntity = categoryMapper.selectByPrimaryKey(spuEntity.getCid1());
            CategoryEntity categoryEntity2 = categoryMapper.selectByPrimaryKey(spuEntity.getCid2());
            CategoryEntity categoryEntity3 = categoryMapper.selectByPrimaryKey(spuEntity.getCid3());
            spuDTO1.setCategoryName(categoryEntity.getName() + "/" + categoryEntity2.getName() + "/" + categoryEntity3.getName());
            */
              /*  第二种
            List<CategoryEntity> categoryEntities = categoryMapper.selectByIdList(Arrays.asList(spuEntity.getCid1(), spuEntity.getCid2(), spuEntity.getCid3()));
            String categoryName = "";
            List<String> categoryNames = new ArrayList<>();
            categoryNames.add(0,"");
            categoryEntities.stream().forEach(categoryEntity -> {
                categoryNames.set(0,categoryNames.get(0) + categoryEntity.getName() + "/");
            });
            categoryName =  categoryNames.get(0).substring(0,categoryNames.get(0).length());
            spuDTO1.setCategoryName(categoryName); */

            // 第三种
            List<CategoryEntity> categoryEntities = categoryMapper.selectByIdList(Arrays.asList(spuEntity.getCid1(), spuEntity.getCid2(), spuEntity.getCid3()));

            String categoryName = categoryEntities.stream().map(categoryEntity -> categoryEntity.getName()).collect(Collectors.joining("/"));
            spuDTO1.setCategoryName(categoryName);

            //品牌名称
            BrandEntity brandEntity = brandMapper.selectByPrimaryKey(spuEntity.getBrandId());
            spuDTO1.setBrandName(brandEntity.getName());

            return spuDTO1;
        }).collect(Collectors.toList());

        PageInfo<SpuEntity> spuEntityPageInfo = new PageInfo<>(spuEntities);
      //  return this.setResultSuccess(spuEntityPageInfo);
        return this.setResult(HTTPStatus.OK,spuEntityPageInfo.getTotal() + "" ,spuDTOList);
    }

}

```



### 新增 (准备)

#### 1， 前台 vue **GoodsFrom.vue**  line:20    line：278

```vue
 line ：20			<v-flex xs5>
                <!--商品分类-->
                <v-cascader
                  url="/category/list"
                  required
                  showAllLevels
                  v-model="goods.categories"
                  label="请选择商品分类"/>
              </v-flex>


line ： 278 
 handler(val) {
        // 判断商品分类是否存在，存在才查询
        if (val && val.length > 0) {
          // 根据分类查询品牌
          this.$http
            .get("/brand/getBrandInfoByCategoryId",{
              params:{
                cid: this.goods.categories[2].id
              }
            })
            .then((resp) => {
              this.brandOptions = resp.data.data;
            });
          // 根据分类查询规格参数
          this.$http
            .get("/specparam/list" ,{
               params:{
                cid:this.goods.categories[2].id
              }
            })
            .then((resp) => {
              let specs = [];
              let template = [];
              if (this.isEdit){
                specs = JSON.parse(this.goods.spuDetail.genericSpec);
                template = JSON.parse(this.goods.spuDetail.specialSpec);
              }
              // 对特有规格进行筛选
              const arr1 = [];
              const arr2 = [];
              resp.data.data.forEach(({id, name,generic, numeric, unit }) => {
                if(generic){
                  const o = { id, name, numeric, unit};
                  if(this.isEdit){
                    o.v = specs[id];
                  }
                  arr1.push(o)
                }else{
                  const o = {id, name, options:[]};
                  if(this.isEdit){
                    o.options = template[id];
                  }
                  arr2.push(o)
                }
              });
              this.specs = arr1;// 通用规格
              this.specialSpecs = arr2;// 特有规格
            });
        }
      }
```



#### line: 57

```
 	<!--2、商品描述-->
      <v-stepper-content step="2">
        <v-editor v-model="goods.spuDetail.description" upload-url="/upload"/>
      </v-stepper-content>
```

#### line: 206

```
  images: images ? images.map(image =>image.data).join(",") : '',
```

#### Editor.vue

#### line: 93

```vue
 this.$http.post(this.uploadUrl, data)
          .then(res => {
            //  修改图片回显路径
            if (res.data.data) {
              this.editor.insertEmbed(this.editor.getSelection().index, 'image', res.data.data)
            }
          })
```



### 2  后台 mingrui-shop-service-api-xxx

#### 2.1 **BrandService**

```java
@ApiOperation(value = "通过分类id查询品牌")
    @GetMapping(value = "brand/getBrandInfoByCategoryId")
    Result<List<BrandEntity>> getBrandInfoByCategoryId(Integer cid);

```



#### 2.2 **mingrui-shop-service-xxx**

#### 2.3 **BrandServiceImpl**

```
   //  通过分类id查询品牌
    @Override
    public Result<List<BrandEntity>> getBrandInfoByCategoryId(Integer cid) {
        List<BrandEntity> list = brandMapper.getBrandInfoByCategoryId(cid);
        return this.setResultSuccess(list);
    }

```



#### 2.4 **BrandMapper**

```
@Select(value = "select * from tb_brand b where b.id in(select cb.brand_id from tb_category_brand cb where cb.category_id=#{cid})")
    List<BrandEntity> getBrandInfoByCategoryId(Integer cid);
```

#### 2.5 **SpecificationServiceImpl**

```
    @Override
    public Result<List<SpecParamEntity>> getSpecParamInfo(SpecParamDTO specParamDTO) {
        SpecParamEntity specParamEntity = BaiduBeanUtil.copyProperties(specParamDTO, SpecParamEntity.class);
        Example example = new Example(SpecParamEntity.class);
        Example.Criteria criteria = example.createCriteria();

        if(ObjectUtil.isNotNull(specParamEntity.getGroupId()))
            criteria .andEqualTo("groupId",specParamEntity.getGroupId());

        if(ObjectUtil.isNotNull(specParamEntity.getCid()))
            criteria.andEqualTo("cid",specParamEntity.getCid());

        List<SpecParamEntity> specParamEntities = specParamMapper.selectByExample(example);
        return this.setResultSuccess(specParamEntities);
    }

```



#### 2.6 **mingrui-shop-service-api-xxx**

##### 2.7  **entity**包下实体类     新建**SpuDetailEntity**

```java
package com.baidu.shop.entity;

import lombok.Data;

import javax.persistence.GeneratedValue;
import javax.persistence.GenerationType;
import javax.persistence.Id;
import javax.persistence.Table;

/**
 * @ClassName SpuDetailEntity
 * @Description: TODO
 * @Author wyj
 * @Date 2021/1/7
 * @Version V1.0
 **/
@Table(name = "tb_spu_detail")
@Data
public class SpuDetailEntity {
    @Id
    private Integer spuId;

    private String description; // 商品描述信息

    private String genericSpec;  // 通用规格参数数据

    private String specialSpec;  // 特有规格参数及可选值信息

    private String packingList;  // 包装清单

    private String afterService; // 售后服务

}

```



##### 2.8 新建 **SkuEntity**

```java
package com.baidu.shop.entity;

import lombok.Data;

import javax.persistence.GeneratedValue;
import javax.persistence.GenerationType;
import javax.persistence.Id;
import javax.persistence.Table;
import java.util.Date;

/**
 * @ClassName SkuEntity
 * @Description: TODO
 * @Author wyj
 * @Date 2021/1/7
 * @Version V1.0
 **/
@Table(name = "tb_sku")
@Data
public class SkuEntity {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY )
    private Long id;

    private Integer spuId;

    private String title;

    private String images;

    private Integer price;

    private String indexes;

    private String ownSpec;

    private Boolean enable;

    private Date createTime;

    private Date lastUpdateTime;
}

```

#### 2.9 新建 **StockEntity**

```java
package com.baidu.shop.entity;

import lombok.Data;

import javax.persistence.Id;
import javax.persistence.Table;

/**
 * @ClassName StockEntity
 * @Description: TODO
 * @Author wyj
 * @Date 2021/1/7
 * @Version V1.0
 **/
@Table(name = "tb_stock")
@Data
public class StockEntity {
 
    @Id
    private  Long skuId;

    private  Integer seckillStock;

    private  Integer seckillTotal;

    private  Integer stock;
}

```



#### 3 , **dto**包下新建**SpuDetailDTO**

```java
package com.baidu.shop.dto;

import io.swagger.annotations.ApiModel;
import io.swagger.annotations.ApiModelProperty;
import lombok.Data;

/**
 * @ClassName SpuDetailDTO
 * @Description: TODO
 * @Author wyj
 * @Date 2021/1/7
 * @Version V1.0
 **/
@ApiModel(value = "spu大字段数据传输类")
@Data
public class SpuDetailDTO {

    @ApiModelProperty(value = "spu主键",example = "1")
    private Integer spuId;

    @ApiModelProperty(value = "商品描述信息")
    private String description;

    @ApiModelProperty(value = "通用规格参数数据")
    private String genericSpec;

    @ApiModelProperty(value = "特有规格参数及可选值信息，JSON格式")
    private String specialSpec;

    @ApiModelProperty(value = "包装清单")
    private String packingList;

    @ApiModelProperty(value = "售后服务")
    private String afterService;
}

```



#### 3.1 **SkuDTO**

```
package com.baidu.shop.dto;

import io.swagger.annotations.ApiModel;
import io.swagger.annotations.ApiModelProperty;
import lombok.Data;

import java.util.Date;

/**
 * @ClassName SkuDTO
 * @Description: TODO
 * @Author wyj
 * @Date 2021/1/7
 * @Version V1.0
 **/
@ApiModel(value = "sku属性数据传输类")
@Data
public class SkuDTO {

    @ApiModelProperty(value = "主键",example = "1")
    private Long id;

    @ApiModelProperty(value = "spu主键",example = "1")
    private Integer spuId;

    @ApiModelProperty(value = "商品标题")
    private String title;

    @ApiModelProperty(value = "商品图片， 多个图片一 ‘，’ 分割")
    private String images;


    @ApiModelProperty(value = "商品销售价格， 单位为分",example = "1")
    private Integer price;

    @ApiModelProperty(value = "特有规格属性在spu属性模板中的对应下标组合")
    private String indexes;

    @ApiModelProperty(value = "sku的特有规格参数键值对，json格式，反序列化时请使用 linkedHashMap，保证有序")
    private  String ownSpec;


    @ApiModelProperty(value = "是否有效，0无效 ， 1有效",example = "1")
    private Boolean enable;

    @ApiModelProperty(value = "添加时间")
    private Date createTime;

    @ApiModelProperty(value = "最后修改时间")
    private Date lastUpdateTime;

    @ApiModelProperty(value = "库存")
    private Integer stock;


}

```



#### 3.2 **StockDTO**

```
package com.baidu.shop.dto;

import io.swagger.annotations.ApiModel;
import io.swagger.annotations.ApiModelProperty;
import lombok.Data;

/**
 * @ClassName StockDTO
 * @Description: TODO
 * @Author wyj
 * @Date 2021/1/7
 * @Version V1.0
 **/
@ApiModel(value = "库存数据传输类")
@Data
public class StockDTO {

    @ApiModelProperty(value = "sku主键",example = "1")
    private Long skuId;

    @ApiModelProperty(value = "可秒杀库存",example = "1")
    private Integer seckillStock;

   @ApiModelProperty(value = "秒杀总数据",example = "1")
    private Integer seckillTotal;

   @ApiModelProperty(value = "库存数量",example = "1")
    private Integer stock;


}

```



#### 3.3 **修改**SpuDTO   新增以下 

```
@ApiModelProperty(value = "大字段数据")
private  SpuDetailDTO spuDetail;

@ApiModelProperty(value = "sku属性数据集合")
private List<SkuDTO> skus;
```



#### 3.4 **GoodsService**

```
    @ApiOperation(value = "添加商品信息")
    @PostMapping(value = "goods/save")
    Result<JSONObject> saveGoods(@RequestBody SpuDTO spuDTO);
```



#### 3.5 **GoodsServiceImpl**

```
  @Transactional
@Override 
public Result<JSONObject> saveGoods(SpuDTO spuDTO) { 

	return this.setResultSuccess();
}
```



### 新增 提交

#### 1.前台 vue

####  GoodsForm.vue line:228 

```
this.$emit("closeForm");
```



#### 2， **mingrui-shop-service-xxx**

#### mapper包下新建SpuDetailMapper

```
package com.baidu.shop.mapper;

import com.baidu.shop.entity.SpuDetailEntity;
import tk.mybatis.mapper.common.Mapper;

/**
 * @ClassName SpuDetailMapper
 * @Description: TODO
 * @Author wyj
 * @Date 2021/1/7
 * @Version V1.0
 **/
public interface SpuDetailMapper extends Mapper<SpuDetailEntity> {
}

```

#####  新建**SkuMapper**

```
package com.baidu.shop.mapper;

import com.baidu.shop.dto.SkuDTO;
import com.baidu.shop.entity.SkuEntity;
import org.apache.ibatis.annotations.Select;
import tk.mybatis.mapper.additional.idlist.DeleteByIdListMapper;
import tk.mybatis.mapper.common.Mapper;
import tk.mybatis.mapper.common.special.InsertListMapper;

import java.util.List;

/**
 * @ClassName SkuMapper
 * @Description: TODO
 * @Author wyj
 * @Date 2021/1/7
 * @Version V1.0
 **/
public interface SkuMapper extends Mapper<SkuEntity>, InsertListMapper<SkuEntity>, DeleteByIdListMapper<SkuEntity,Long> {
   
}

```

####  新建 **StockMapper**

```
package com.baidu.shop.mapper;

import com.baidu.shop.entity.StockEntity;
import tk.mybatis.mapper.additional.idlist.DeleteByIdListMapper;
import tk.mybatis.mapper.common.Mapper;

/**
 * @ClassName StockMapper
 * @Description: TODO
 * @Author wyj
 * @Date 2021/1/7
 * @Version V1.0
 **/
public interface StockMapper extends Mapper<StockEntity>, DeleteByIdListMapper<StockEntity,Long> {
}

```

###  3， **GoodsServiceImpl**

```java
  @Transactional
    @Override  // 添加
    public Result<JSONObject> saveGoods(SpuDTO spuDTO) {
        //   log.info("{}",spuDTO);
        final Date date = new Date();
        //新增 spu 新增需要设置 返回主键 @GeneratedValue(strategy = GenerationType.IDENTITY )  给必要的字段赋默认值
        SpuEntity spuEntity = BaiduBeanUtil.copyProperties(spuDTO, SpuEntity.class);
        spuEntity.setSaleable(1);
        spuEntity.setValid(1);
        spuEntity.setCreateTime(date);
        spuEntity.setLastUpdateTime(date);
        spuMapper.insertSelective(spuEntity);

        // 新增 SpuDetailEntity
        SpuDetailDTO spuDetail = spuDTO.getSpuDetail();
        SpuDetailEntity spuDetailEntity = BaiduBeanUtil.copyProperties(spuDetail, SpuDetailEntity.class);
        spuDetailEntity.setSpuId(spuEntity.getId());
        spuDetailMapper.insertSelective(spuDetailEntity);

    
       //新增 sku
        List<SkuDTO> skus = spuDTO.getSkus();
        skus.stream().forEach(skuDTO -> {
            SkuEntity skuEntity = BaiduBeanUtil.copyProperties(skuDTO, SkuEntity.class);
            skuEntity.setSpuId(spuEntity.getId());
            skuEntity.setCreateTime(date);
            skuEntity.setLastUpdateTime(date);
            skuMapper.insertSelective(skuEntity);
            // 新增 stock
            StockEntity stockEntity = new StockEntity();
            stockEntity.setSkuId(skuEntity.getId());
            stockEntity.setStock(skuDTO.getStock());
            stockMapper.insertSelective(stockEntity);
        });

        return this.setResultSuccess();
    }

```

### 

### 修改 （回显）

#### 1，前台 vue

####  **Goods.vue**   改动如下  

#### line： 169 

```
 editItem(item) {
 		// 获得品牌分类名称  和GoodsFrom.vue 里的监听中有冲突  需要注释掉  且只能注释这里的
       // this.selectedGoods = item;
        // const names = item.categoryName.split("/");
        // this.selectedGoods.categories = [
        //   {id: item.cid1, name: names[0]},
        //   {id: item.cid2, name: names[1]},
        //   {id: item.cid3, name: names[2]}
        // ];
         // 查询商品详情   保证isEdit状态为true
        this.isEdit = true;
        this.show = true;
        
        // 解决多次监听问题  使只监听一次只监控一次oldGoods
        let obj = item; 

        // 查询商品详情
        this.$http.get("/goods/getSpuDetailBySpuId" ,{
          params:{
            spuId : item.id
          }
        })
          .then(resp => {
            // this.selectedGoods.spuDetail = resp.data.data;
            // this.selectedGoods.spuDetail.specTemplate = JSON.parse(resp.data.data.specialSpec);
            // this.selectedGoods.spuDetail.specifications = JSON.parse(resp.data.data.genericSpec);
            obj.categories = [];
            obj.spuDetail = resp.data.data;
            obj.spuDetail.specTemplate =JSON.parse(resp.data.data.specialSpec);  // 特有规格参数
            obj.spuDetail.specifications = JSON.parse(resp.data.data.genericSpec);  // 通用规格参数

            this.$http.get('/goods/getSkuBySpuId',{
              params:{
                spuId : item.id
              }
            }).then( (resp) =>{
              obj.skus = resp.data.data;
              this.selectedGoods = obj ;
              console.log(resp)
            }).catch( (error) => console.log(error))

          })
      },
```

#### 2，**GoodsForm.vue**  

#####  监听函数

```
 watch: {
    oldGoods: {
      deep: true,
      handler(val) {
        if (!this.isEdit) {
          Object.assign(this.goods, {
            categories: null, // 商品分类信息
            brandId: 0, // 品牌id信息
            title: "", // 标题
            subTitle: "", // 子标题
            spuDetail: {
              packingList: "", // 包装列表
              afterService: "", // 售后服务
              description: "" // 商品描述
            }
          });
          this.specs = [];
          this.specialSpecs = [];
        } else {
          this.goods = Object.deepCopy(val);

 		// 先得到分类名称
          const names = val.categoryName.split("/");
          window.setTimeout( () =>{
            // 组织商品分类数据
            this.goods.categories = [
              { id: val.cid1, name: names[0] },
              { id: val.cid2, name: names[1] },
              { id: val.cid3, name: names[2] }
            ];  
          },100)
         
          // 将skus处理成map
          const skuMap = new Map();
          this.goods.skus.forEach(s => {
            skuMap.set(s.indexes, s);
          });
          this.goods.skus = skuMap;
        }
      }
    },
    "goods.categories": {
      deep: true,
      handler(val) {
        // 判断商品分类是否存在，存在才查询
        if (val && val.length > 0) {
          // 根据分类查询品牌
          this.$http
            .get("/brand/getBrandInfoByCategoryId",{
              params:{
                cid: this.goods.categories[2].id
              }
            })
            .then((resp) => {
              this.brandOptions = resp.data.data;
            });
          // 根据分类查询规格参数
          this.$http
            .get("/specparam/list" ,{
               params:{
                cid:this.goods.categories[2].id
              }
            })
            .then((resp) => {
              let specs = [];
              let template = [];
              if (this.isEdit){
                specs = JSON.parse(this.goods.spuDetail.genericSpec);
                template = JSON.parse(this.goods.spuDetail.specialSpec);
              }
              // 对特有规格进行筛选
              const arr1 = [];
              const arr2 = [];
              resp.data.data.forEach(({id, name,generic, numeric, unit }) => {
                if(generic){
                  const o = { id, name, numeric, unit};
                  if(this.isEdit){
                    o.v = specs[id];
                  }
                  arr1.push(o)
                }else{
                  const o = {id, name, options:[]};
                  if(this.isEdit){
                    o.options = template[id];
                  }
                  arr2.push(o)
                }
              });
              this.specs = arr1;// 通用规格
              this.specialSpecs = arr2;// 特有规格
            });
        }
      }
    }
  },
```



#### 后台  **mingrui-shop-service-api-xxx**

####  **GoodsService**

```
 // /goods/getSpuDetailBySpuId
    @ApiOperation(value = "通过spuid查询SpuDetail的信息")
    @GetMapping(value = "goods/getSpuDetailBySpuId")
    Result<SpuDetailEntity> getSpuDetailBySpuId(Integer spuId);

    // goods/getSkuBySpuId
    @ApiOperation(value = "通过spuid查询sku的信息")
    @GetMapping(value = "goods/getSkuBySpuId")
    Result<List<SkuDTO>> getSkuBySpuId(Integer spuId);

```

#### **mingrui-shop-service-xxx**

####  **SkuMapper**

```
package com.baidu.shop.mapper;

import com.baidu.shop.dto.SkuDTO;
import com.baidu.shop.entity.SkuEntity;
import org.apache.ibatis.annotations.Select;
import tk.mybatis.mapper.additional.idlist.DeleteByIdListMapper;
import tk.mybatis.mapper.common.Mapper;
import tk.mybatis.mapper.common.special.InsertListMapper;

import java.util.List;

/**
 * @ClassName SkuMapper
 * @Description: TODO
 * @Author wyj
 * @Date 2021/1/7
 * @Version V1.0
 **/
public interface SkuMapper extends Mapper<SkuEntity>, InsertListMapper<SkuEntity>, DeleteByIdListMapper<SkuEntity,Long> {
    @Select(value = "select k.*,stock from tb_sku k ,tb_stock t where k.id = t.sku_id and k.spu_id = #{spuId}")
    List<SkuDTO> getSkusAndStockBySpuId(Integer spuId);
}

```

#### **GoodsServiceImpl**

```
  @Override
    public Result<SpuDetailEntity> getSpuDetailBySpuId(Integer spuId) {
        SpuDetailEntity spuDetailEntity = spuDetailMapper.selectByPrimaryKey(spuId);
        return this.setResultSuccess(spuDetailEntity);
    }

    @Override
    public Result<List<SkuDTO>> getSkuBySpuId(Integer spuId) {
        List<SkuDTO> list = skuMapper.getSkusAndStockBySpuId(spuId);
        return this.setResultSuccess(list);
    }

```

#### 修改 （提交）

#### 1，前台 vue   **GoodsForm.vue**   line： 221 

```
  this.$http({
        method: this.isEdit ? "put" : "post",
        url: "/goods/save",
        data: goodsParams
      })
```

#### 2，后台 **mingrui-shop-service-api-xxx**

**GoodsService**

```
	@ApiOperation(value = "修改商品信息")
    @PutMapping(value = "goods/save")
    Result<JSONObject> editGoods(@RequestBody SpuDTO spuDTO);
```

#### 3， **mingrui-shop-service-xxx**

####  修改**SkuMapper**和StockMapper

```
package com.baidu.shop.mapper;

import com.baidu.shop.dto.SkuDTO;
import com.baidu.shop.entity.SkuEntity;
import org.apache.ibatis.annotations.Select;
import tk.mybatis.mapper.additional.idlist.DeleteByIdListMapper;
import tk.mybatis.mapper.common.Mapper;
import tk.mybatis.mapper.common.special.InsertListMapper;
import java.util.List;
/**
 * @ClassName SkuMapper
 * @Description: TODO
 * @Author wyj
 * @Date 2021/1/7
 * @Version V1.0
 **/
public interface SkuMapper extends Mapper<SkuEntity>, InsertListMapper<SkuEntity>, DeleteByIdListMapper<SkuEntity,Long> {
    @Select(value = "select k.*,stock from tb_sku k ,tb_stock t where k.id = t.sku_id and k.spu_id = #{spuId}")
    List<SkuDTO> getSkusAndStockBySpuId(Integer spuId);
}

///------------------------------------
StockMapper

package com.baidu.shop.mapper;
import com.baidu.shop.entity.StockEntity;
import tk.mybatis.mapper.additional.idlist.DeleteByIdListMapper;
import tk.mybatis.mapper.common.Mapper;

/**
 * @ClassName StockMapper
 * @Description: TODO
 * @Author wyj
 * @Date 2021/1/7
 * @Version V1.0
 **/
public interface StockMapper extends Mapper<StockEntity>, DeleteByIdListMapper<StockEntity,Long> {
}

```

#### 4， **GoodsServiceImpl**

```
 @Transactional
    @Override    // 修改商品信息
    public Result<JSONObject> editGoods(SpuDTO spuDTO) {
        final Date date = new Date();
        // 修改 spu
        SpuEntity spuEntity = BaiduBeanUtil.copyProperties(spuDTO, SpuEntity.class);
        spuEntity.setLastUpdateTime(date);
        spuMapper.updateByPrimaryKeySelective(spuEntity);

        // 修改 spuDetail
        SpuDetailEntity spuDetailEntity = BaiduBeanUtil.copyProperties(spuDTO.getSpuDetail(), SpuDetailEntity.class);
        spuDetailMapper.updateByPrimaryKeySelective(spuDetailEntity);

        this.deleteSkuAndStockInfo(spuEntity.getId());

          /*
        //  修改sku  先删除  在修改（新增）
        Example example = new Example(SkuEntity.class);
        example.createCriteria().andEqualTo("spuId",spuDTO.getId());
        List<SkuEntity> skuEntities = skuMapper.selectByExample(example);
        List<Long> skuIdList  = skuEntities.stream().map(sku -> sku.getId()).collect(Collectors.toList());
        skuMapper.deleteByIdList(skuIdList );
        stockMapper.deleteByIdList(skuIdList );*/

        this.saveSkuAndStockInfo(spuDTO,spuEntity.getId(),date);
      
      /*  修改（新增） skuEntity  通用代码提取
        List<SkuDTO> skus = spuDTO.getSkus();
        skus.stream().forEach(skuDTO -> {
            SkuEntity skuEntity = BaiduBeanUtil.copyProperties(skuDTO, SkuEntity.class);
            skuEntity.setSpuId(spuEntity.getId());
            skuEntity.setCreateTime(date);
            skuEntity.setLastUpdateTime(date);
            skuMapper.insertSelective(skuEntity);

            // 新增 stock
            StockEntity stockEntity = new StockEntity();
            stockEntity.setSkuId(skuEntity.getId());
            stockEntity.setStock(skuDTO.getStock());
            stockMapper.insertSelective(stockEntity);
        });*/

        return this.setResultSuccess();
    }
```

####  新增和修改中 重复代码提取

```
private void saveSkuAndStockInfo(SpuDTO spuDTO,Integer spuId,Date date){
    // 修改（新增） skuEntity   // 通用代码提取
    List<SkuDTO> skus = spuDTO.getSkus();
    skus.stream().forEach(skuDTO -> {
        SkuEntity skuEntity = BaiduBeanUtil.copyProperties(skuDTO, SkuEntity.class);
        skuEntity.setSpuId(spuId);
        skuEntity.setCreateTime(date);
        skuEntity.setLastUpdateTime(date);
        skuMapper.insertSelective(skuEntity);

        // 新增 stock
        StockEntity stockEntity = new StockEntity();
        stockEntity.setSkuId(skuEntity.getId());
        stockEntity.setStock(skuDTO.getStock());
        stockMapper.insertSelective(stockEntity);
    });

}
```

### 删除

####  前台 

#### 1, Goods.vue    line : 211

```
   this.$http.delete("/goods/delete",{
           params:{
           spuId:id
           }
      })
```



#### 2, 后台 **mingrui-shop-service-api-xxx**

#### **GoodsService**

```
@ApiOperation(value = "修改商品信息")
@DeleteMapping(value = "goods/delete")
Result<JSONObject> deleteGoods(Integer spuId);
```

#### **mingrui-shop-service-xxx**

#### **GoodsServiceImpl**

```java
   @Transactional
    @Override   // 删除 商品
    public Result<JSONObject> deleteGoods(Integer spuId) {
        //删除 spu
        spuMapper.deleteByPrimaryKey(spuId);
        // 删除spuDetail
        spuDetailMapper.deleteByPrimaryKey(spuId);

        this.deleteSkuAndStockInfo(spuId);
        /*
        //  修改sku  先删除  在修改（新增）  重复代码提取
        Example example = new Example(SkuEntity.class);
        example.createCriteria().andEqualTo("spuId",spuId);
        List<SkuEntity> skuEntities = skuMapper.selectByExample(example);
        List<Long> skuIdList  = skuEntities.stream().map(sku -> sku.getId()).collect(Collectors.toList());
        skuMapper.deleteByIdList(skuIdList );
        stockMapper.deleteByIdList(skuIdList );*/

        return this.setResultSuccess();
    }

```



#####  删除和修改中重复代码提取

```java
   //  删除和修改中的 重复代码 提取 用来删除 sku和stock 表中的数据
    private void deleteSkuAndStockInfo(Integer spuId){
        //  修改sku  先删除  在修改（新增）  重复代码提取
        Example example = new Example(SkuEntity.class);
        example.createCriteria().andEqualTo("spuId",spuId);
        List<SkuEntity> skuEntities = skuMapper.selectByExample(example);
        List<Long> skuIdList  = skuEntities.stream().map(sku -> sku.getId()).collect(Collectors.toList());
        skuMapper.deleteByIdList(skuIdList );
        stockMapper.deleteByIdList(skuIdList );
    }

```



### 商品上架和下架实现

#### 前台vue  Goods

##### line：51

```
   <v-btn icon small v-if="props.item.saleable" @click="isSaleable(props.item)">下架</v-btn>
     <v-btn icon v-else @click="isSaleable(props.item)">上架</v-btn>
```



```
 isSaleable(saleable){
            this.$http({
              url:'/goods/alterSaleable',
              method:'put',
              data:saleable
            } ).then( (resp) =>{
                this.getDataFromApi();
                this.$message.success(resp.data.message);
            }).catch( (error) => console.log(error))
      },
```

#### 后台 **mingrui-shop-service-api-xxx**

**GoodsService**

```
    // goods/alterSaleable
    @ApiOperation(value = "商品上架和下架")
    @PutMapping(value = "goods/alterSaleable")
    Result<JSONObject> alterSaleable(@Validated({MingruiOperation.Update.class}) @RequestBody SpuDTO spuDTO);
```

#### **mingrui-shop-service-xxx**

#### GoodsServiceImpl

```
   @Transactional
    @Override
    public Result<JSONObject> alterSaleable(SpuDTO spuDTO) {
        SpuEntity spuEntity = BaiduBeanUtil.copyProperties(spuDTO, SpuEntity.class);

        if(ObjectUtil.isNotNull(spuEntity.getSaleable()) && spuDTO.getSaleable() < 2){
            if(spuEntity.getSaleable() == 1){
                spuEntity.setSaleable(0);
                spuMapper.updateByPrimaryKeySelective(spuEntity);
                return this.setResultSuccess("成功修改为下架");
            }else {
                spuEntity.setSaleable(1);
                spuMapper.updateByPrimaryKeySelective(spuEntity);
                return this.setResultSuccess("成功修改为上架");
            }
        }

        return this.setResultSuccess();
    }
```

